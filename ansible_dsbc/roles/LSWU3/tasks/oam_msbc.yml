---
  - name: spawning the  active instance
    register: stack_create
    os_stack:
       name: "{{ item.stack_name }}"
       tag: "{{ item.stack_name }}"  
       state: "{{ present_or_absent }}"
       validate_certs: false
       template: "{{ item.template }}"
       parameters:
           flavor: "{{ item.flavor }}"
           image: "{{ item.base_build }}"
           security_group: "{{ item.sg }}"
           mgt0IPAddress: "{{ item.mgt0IPAddress }}"
    loop: "{{ ssbc_nodes }}"
    loop_control:
       pause: 20 
  - name: Wait until the active instance pings
    wait_for:
       host: "{{ item.mgt0IPAddress }}"
       port: 2024
       delay: 60
       timeout: 120
       state: started
       msg: " Active Instance waiting to ping "
    loop: "{{ ssbc_nodes }}"
       
  - name: Checking the Mgmt IP of Active Node is pingable or not
    shell: ping -c2 {{ item.mgt0IPAddress }}
    register: a
#  - debug: var=a.stdout_lines 
    loop: "{{ ssbc_nodes }}"
  - debug:
      msg: "{{ item.stdout_lines }}"
    loop: "{{ a.results }}"
 
  - name: wait for 30 seconds
    wait_for:
      timeout: 30
 
#  - name: checking if any core file generated, fails task if generated .
#    shell: 
#      "ls -alrt | grep -w core|wc -l"
#    args:
#     chdir: /var/log/sonus/sbx/coredump/
#    delegate_to: active-1
#    register: b
#    failed_when: '"0" not in b.stdout'
#  - debug: var=b.stdout_lines




  - name: checking if any core file generated, fails task if generated .
    shell:
      "ls -alrt | grep -w core|wc -l"
    args:
     chdir: /var/log/sonus/sbx/coredump/
    delegate_to: "{{item}}"

    loop: "{{groups['ssbc']}}"

    register: b
    failed_when: '"0" not in b.stdout'

  - debug:
      msg: "{{ item.stdout_lines }}"
    loop: "{{ b.results }}"





  - block:
      - name: Moving the files from localhost to both nodes
 
        copy:
          src: /home/ansible/timeout1.sh
          dest: /root/
          mode: '0777'
          force: yes
        delegate_to: "{{item}}"
 
        loop: "{{groups['ssbc']}}"




      - name: waiting for service to become available
        shell: sh  timeout1.sh
        args:
         chdir: /root/
 
        delegate_to: "{{item}}"
        loop: "{{groups['ssbc']}}"
        register: command_result
    #    failed_when: command_result.rc not in (0,255)
        when: a is succeeded
    rescue:
      - name: Active Instance didnot come up.
        debug: msg="There was an error in the block."




  - name: checking sync status
    shell: curl -kisu 'admin:admin' -X GET https://{{item.mgt0IPAddress}}/api/operational/system/syncStatus/ | grep status
    register: b
    loop: "{{ ssbc_nodes }}"
#  - debug: var=b.stdout_lines
  - debug:
      msg: "{{ item.stdout_lines }}"
    loop: "{{ b.results }}"

    



#  - name: checking sync status
#    shell: curl -kisu 'admin:admin' -X GET https://{{mgt0IPAddress_STANDBY}}/api/operational/system/syncStatus/ | grep status
#    register: c
#  - debug: var=c.stdout_lines



  

#  - block:
#      - name: Moving the files from localhost to active node
#        become: True
#        copy:
#          src: /home/ansible/timeout1.sh
#          dest: /root/
#          mode: '0777'
#          force: yes
#        delegate_to: active-1
#
#
#
#      - name: waiting for service to become available for active node
#        shell: sh  timeout1.sh
#        args:
#         chdir: /root/
#        delegate_to: active-1
#        register: command_result
#        failed_when: command_result.rc not in (0,255)
#        when: a is succeeded
#    rescue:
#      - name: Active Instance didnot come up.
#        debug: msg="There was an error in the block."
#  
#  - name: system_coredumplist
#    shell: curl -kisu 'admin:admin' -X GET https://{{mgt0IPAddress_ACTIVE}}/api/operational/system/coredumpSummary/vsbc1|grep -w "coredumpAndTraceCount"
#    register: b
#    delegate_to: bats14
#  - debug: var=b.stdout_lines
#  - name: To check installed software version
#    shell:
#          "/opt/sonus/sbx/scripts/swinfo.sh"
#    delegate_to: active-1
#    register: b
#  - debug: var=b.stdout_lines
#
#  - name: checking sync status
#    shell: curl -kisu 'admin:admin' -X GET https://{{mgt0IPAddress_ACTIVE}}/api/operational/system/syncStatus/ | grep status
#    register: b
#  - debug: var=b.stdout_lines
#


 
