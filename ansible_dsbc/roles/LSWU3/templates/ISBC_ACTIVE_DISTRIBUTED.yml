heat_template_version: 2015-04-30
description: Template to setup and deploy a Standalone vSBC compute instances

##################################################################################################
# IMPORTANT NOTE to configure second management port 'mgt1':
#
#  1. By Default, configuration of second management port is commented out in this template.
#
#  2. To enable configuration of second management port 'mgt1', search for the following tag and follow the instructions with the tag:
#     Tag to search : 'MGT1_EDIT'
#
#  3. Add the entries for second management port 'mgt1' in metadata section of each instance corressponding to the entries
#     that are already there for 'mgt0' interface.
#
#     For example:
#      In metadata section: add the IF metadata related data for second management port like:
#
#        IF4:
#             str_replace:
#               template: |
#                 { "Port": "$port_name",
#                   "DHCP": "$dhcp_flag",
#                   "GW$ip_version": "$gateway_ip",
#                   "IP$ip_version": "$ip_address"
#                 }
#               params:
#                 $port_name:  "Mgt1"
#                 $dhcp_flag:  { get_param: isDhcpEnabledOnMgt1}
#                 $ip_version: { get_param: mgt1IpVersion }
#                 $gateway_ip: { get_param: mgt1Gateway }
#                 $ip_address: { list_join: ['/', [ { get_param: mgt1IPAddress }, { get_param: mgt1SubnetPrefix}]] }
#
#
# 1. Sample Environment content to be sourced with this template:
#
#    parameters:
#
#      # System Settings
#      image:           myImage
#      flavor:          cloudSBC.lite
#      security_group:  vSBC_security_group
#
#      # Private Network Settings
#      provider_network_mgt0: mgt0
#      provider_network_mgt1: mgt1
#      provider_network_ha:   ha0
#      provider_network_pkt0: pkt0
#      provider_network_pkt1: pkt1
#
# 2. To Enable/Disable SR-IOV on any interface, search for '<interfaceName> EDIT:'
#    and follow instructions there
#
#    E.g. To Enable SRIOV on Packet Port 0 (pkt0):
#         Search for: 'pkt0 EDIT:' (without quotes)
#         (Replace pkt0 with mgt0, ha0 or pkt1 as applicable)
#
#    Sample code segment:
#      # pkt0 EDIT: Below line:
#      #   SR-IOV support:    uncomment
#      #   No SR-IOV support: comment
#      #binding:vnic_type: direct
#
#
# 3. Additional private IPs will be queried by the template when launched as a comma-separeted input.
#    These IP addresses will be queried inside template at multiple places, and the procedure for the same is given in next point.
#    Make sure that the comma-separated input doesn't have spaces between them. That would lead to template-load error.
#
# 4. Procedure for adding additional IP address to ports.
#
#    This involves the following steps which are described in detail below:
#       - Private port creation and
#       - Meta data update.
#
#    Procedure:
#
#    a) Search for the tags "EDIT_PRIVATE_PORT_CREATION_PKT0" and "EDIT_PRIVATE_PORT_CREATION_PKT1"
#       * Add additional IP address to the PKT ports by uncommenting out
#         "- ip_address:" parameters and query the IP address from the list input as give below:
#
#         - ip_address: {get_param: [pktXAdditionalIPs,0]}
#
#       * Where X : { 0 for Pkt0, 1 for Pkt1 }
#
#       * Repeat this multiple times based on number
#         of IP addresses to be assigned to the port
#
#    b) Appending Metadata content of server above the section METADATA_APPEND_ABOVE.
#
#         ALT_PKTX_01: { "IFName": "YYY", "IP": {get_param: [pktXAdditionalIPs,0]}}
#
#         * Where:
#          - X can be 0 or 1.
#          - ALT_PKTX_01 can be replaced with any valid name for alternate IP.
#          - YYY is the corresponding IF name of PKT port. Eg: IF2 for Pkt0
#
# 5. To Enable PKT Port Redundancy feature follow below instructions-:
#    a)Search for the tag "Create active vSBC instance"
#      -Uncomment out these two lines in the "networks:" section "- port: { get_resource: pkt0S_port1 }" and "- port: { get_resource: pkt1S_port1 }"
#    b) Search for the tags "EDIT_PRIVATE_PORT_CREATION_PKT0S_START" and "EDIT_PRIVATE_PORT_CREATION_PKT1S_START"
#       -Uncomment out all lines between "EDIT_PRIVATE_PORT_CREATION_PKT0S_START" and "EDIT_PRIVATE_PORT_CREATION_PKT0S_END".
#       -Uncomment out all lines between "EDIT_PRIVATE_PORT_CREATION_PKT1S_START" and "EDIT_PRIVATE_PORT_CREATION_PKT1S_END".
#    c)We should add both the ports at once.We cannot use template after adding only either of the ports.
#    d)Search for "Networks Settings"
#      -Uncomment out these two lines in "the parameters:" section - provider_network_pkt0_standby and - provider_network_pkt1_standby
#    e)serach for the tags "EDIT_PKT0S_PROVIDER_NETWORK_START"  and "EDIT_PKT1S_PROVIDER_NETWORK_START"
#      -Uncomment out all the lines between "EDIT_PKT0S_PROVIDER_NETWORK_START"  and "EDIT_PKT0S_PROVIDER_NETWORK_END".
#      -Uncomment out all the lines between "EDIT_PKT1S_PROVIDER_NETWORK_START"  and "EDIT_PKT1S_PROVIDER_NETWORK_END".
#    f)In port redundancy by default extra RX cores is allocated to poll standby port for providing
#      DoS support on standby port. This extra allocation of core can be controlled by tag "dos_support_sec_port".
#      If extra core allocation has to be prevented when prompted option for this attribute, choose False.
#      In non port redundancy case this tag will not have any impact.
#
#    NOTE:Currently this feature is supported only for all sriov enable packet ports i.e all 4 pkt ports should be sriov enable.
#
#
# IMPORTANT NOTE to be able to login with ssh keys or password.
#
# From 7.1 onwards users have to give ssh keys or passwords in the heat template to login into CLI or linux shell.
# Since use of ssh keys is more secured hence it is a mandatory field now in the heat template.
#
# Users can use ssh-keygen command to generate keys. This command generates two files id_rsa and id_rsa.pub
# in /home/<user>/.ssh directory. The content of id_rsa.pub file will be the input value for the keys in this
# heat template. Optionally keys can also be protected using a passphrase. For more options on ssh-keygen please do man ssh-keygen.
#
# Passwords are optional fields. Please note that the password input is not a plain text password. It is a hash of
# the password. The hash password can be generated using the command mkpasswd --method=SHA-512 --rounds=4096.
# For more options on mkpasswd please do man mkpasswd.
#
##################################################################################################

parameter_groups:
- label: System Settings
  description: System Level Settings
  parameters:
  - image
  - flavor
  - security_group
  - sbc_system_name
  - personality
  - dos_support_sec_port
  - availability_zone
- label: Network Settings
  description: Network Settings
  parameters:
  - provider_network_mgt0
  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #- provider_network_mgt1
  - provider_network_ha
  - provider_network_pkt0
  - provider_network_pkt1
  #- provider_network_pkt0_standby
  #- provider_network_pkt1_standby

- label: mgt0 DHCP Settings
  description: DHCP Settings for Management Port 0
  parameters:
  - mgt0IpVersion
  - isDhcpEnabledOnMgt0
  - mgt0IPAddress
  - mgt0SubnetPrefix
  - mgt0Gateway

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
#- label: mgt1 DHCP Settings
#  description: DHCP Settings for Management Port 1
#  parameters:
#  - mgt1IpVersion
#  - isDhcpEnabledOnMgt1
#  - mgt1IPAddress
#  - mgt1SubnetPrefix
#  - mgt1Gateway

- label: ha0 DHCP Settings
  description: DHCP Settings for High Availability Port
  parameters:
  - isDhcpEnabledOnHa0
  - ha0IPAddress
  - ha0SubnetPrefix
  - ha0Gateway

- label: pkt0 DHCP Settings
  description: DHCP Settings for Packet Port 0
  parameters:
  - pkt0IpVersion
  - isDhcpEnabledOnPkt0
  - pkt0IPAddress
  - pkt0SubnetPrefix
  - pkt0Gateway
  - vlanIdPkt0
#  - pkt0AdditionalIPs

- label: pkt1 DHCP Settings
  description: DHCP Settings for Packet Port 1
  parameters:
  - pkt1IpVersion
  - isDhcpEnabledOnPkt1
  - pkt1IPAddress
  - pkt1SubnetPrefix
  - pkt1Gateway
  - vlanIdPkt1
#  - pkt1AdditionalIPs

- label: Instance Specific Settings
  description: Instance Specific Settings
  parameters:
  - sbc_ceName
  - sbc_ceRole
  - sbc_rgIp

- label: EMS Settings
  description: EMS Settings
  parameters:
  - ems_user_name
  - ems_password
  - ems_ip_1
  - ems_ip_2
  - cluster_id
  - download_config

- label: SBC Login Credentials
  description: SBC Login input - ssh key or password
  parameters:
  - adminSshKey
  - linuxAdminSshKey
  - adminPassword
  - linuxAdminPassword

parameters:

############################
# System Level Settings
############################

  image:
    type: string
    label: Image Name
    description: Image to be used for launching the instance(s)
 #   default: sbc-V08.00.00R000_R000_4
  flavor:
    type: string
    label: Flavor
    description: Flavor to be used for instance(s)
#    default: ISBC4VCPU

  security_group:
    type: string
    label: Security Group
#    default: ansible
    

  availability_zone:
    type: string
    label: Availability Zone_Active
    description: Which Availability Zone MADTOM PIRANHA SLICKHEAD TORPEDO ROCKLING
    default: ansible

  sbc_system_name:
    type: string
    label: SBC System Name
    description: SBC system name
    default: vsbcSystem
    constraints:
      - length: { min: 0, max: 26 }
        description: "Enter valid system name. Length of this string should be less than 26"
      - allowed_pattern: "^[A-Za-z]{1}[-A-Za-z0-9]*[A-Za-z0-9]{1}$"
        description: "Enter valid system name. Regex: ^[A-Za-z]{1}[-A-Za-z0-9]*[A-Za-z0-9]{1}$ "

  personality:
    type: string
    label: SBC Personality Type
    description: Configures SBC instance to be Signaling,Media or Integrated node.
    default: isbc
    constraints:
      - allowed_values: [ssbc,msbc,isbc]

  dos_support_sec_port:
    type: string
    label: DoS Support On secondary packet ports.[Applicable only for port redundancy]
    description: Launches secondary Rx cores if port redundancy is enabled to support DoS protection for secondary packet ports.
    default: False
    constraints:
      - allowed_values: [True,False]

############################
# Network Settings
############################

  provider_network_mgt0:
    type: string
    label: Management Port 0 Provider Network Name or ID
    description: Name/ID of private network for mgt0.
    default: PR_MGMT

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #provider_network_mgt1:
  #  type: string
  #  label: Management Port 1 Provider Network Name or ID
  #  description: Name/ID of private network for mgt1.
  #  constraints:
  #    - custom_constraint: 'neutron.network'

  provider_network_ha:
    type: string
    label: HA Port Private Network Name or ID
    description: Name/ID of private network for ha0.
    default: ha_internal

  provider_network_pkt0:
    type: string
    label: Packet Port 0 Provider Network Name or ID
    description: Name/ID of private network for pkt0.
    default: sriov_pkt0

  provider_network_pkt1:
    type: string
    label: Packet Port 1 Provider Network Name or ID
    description: Name/ID of private network for pkt1.
    default: sriov_pkt1

  # EDIT_PKT0S_PROVIDER_NETWORK_START
  #provider_network_pkt0_standby:
    #type: string
    #label: Packet Port 0 standby Provider Network Name or ID
    #description: Name/ID of private network for pkt0 standby.
    #constraints:
      #- custom_constraint: 'neutron.network'

  # EDIT_PKT0S_PROVIDER_NETWORK_END

  # EDIT_PKT1S_PROVIDER_NETWORK_START
  #provider_network_pkt1_standby:
    #type: string
    #label: Packet Port 1 standby Provider Network Name or ID
    #description: Name/ID of private network for pkt1 standby.
    #constraints:
      #- custom_constraint: 'neutron.network'

  # EDIT_PKT1S_PROVIDER_NETWORK_END



###########################################################
# VLAN ID PKT interfaces
# Keeping it a string value instead of integer, as we need
# to support None value
###########################################################

  vlanIdPkt0:
    type: string
    label: Packet Port 0 VLAN ID
    description: Packet Port 0 VLAN ID
    default : 626

  vlanIdPkt1:
    type: string
    label: Packet Port 1 VLAN ID
    description: Packet Port 1 VLAN ID
    default : 627

############################
# Instance Specific Settings
############################
  sbc_ceName:
    type: string
    label: SBC Instance Name
    description: SBC Instance name.
    default: "vsbc1"
    constraints:
      - length: { min: 0, max: 63 }
        description: "Enter valid active instance name. Length of this string should be less than 63"
      - allowed_pattern: "^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$"
        description: "Enter valid active instance name. Regex: ^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$ "

  sbc_ceRole:
    type: string
    label: SBC Configured CE Role
    description: SBC Configured CE Role.
    default: "ACTIVE"
    constraints:
      - length: { min: 0, max: 8 }
        description: "Enter valid instance role. Role can be ACTIVE or STANDBY"
      - allowed_pattern: "^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$"
        description: "Enter valid instance role. Regex: ^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$ "
      - allowed_values: [ACTIVE,STANDBY]

  sbc_rgIp:
    type: string
    label: HA port IP address of one of the members of SBC Redundancy Group(RG). (Note - Provide 169.254.88.1 for the first node of RG)
    description: SBC RG is formed by communicating over the provided IP. When adding 3rd or subsequent instance to RG, can provide HA IP of any of the instances that are up and running.
    default: "192.168.20.40"
    constraints:
      - length: { min: 0, max: 63 }
        description: "Enter valid IP."
      - allowed_pattern: "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$"
        description: "Enter valid cluster IP. Regex: ^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$"

################
# EMS Settings
################
  ems_user_name:
    type: string
    label: EMS User Name
    description: User name for registering with EMS
    default: "None"

  ems_password:
    type: string
    label: EMS Password
    description: EMS registration password
    hidden: true
    default: "None"

  ems_ip_1:
    type: string
    label: EMS IP 1
    description: EMS IP Address 1 - e.g. 10.52.13.40 (No quotes required)
    default: ""

  ems_ip_2:
    type: string
    label: EMS IP 2
    description: EMS IP Address 2 - e.g. 51.12.30.24 (No quotes required)
    default: ""

  cluster_id:
    type: string
    label: Cluster ID
    description: Cluster/VNF ID value from EMS Cluster Mgmt.
    default: ""

  download_config:
    type: string
    label: Download Configuration from EMS
    description: Download Configuration from EMS
    default: False
    constraints:
      - allowed_values: [True,False]


##################################
# IP address of the Non-DHCP ports
##################################
  mgt0IPAddress:
    type: string
    label: Management Port 0 IP Address
    description: IP address for mgt0 port
    default : 10.34.224.40

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #mgt1IPAddress:
  #  type: string
  #  label: Management Port 1 IP Address
  #  description: IP address for mgt1 port
  #  default : None

  ha0IPAddress:
    type: string
    label: High Availability Port IP Address
    description: IP address for ha0 port
    default : 192.168.20.40

  pkt0IPAddress:
    type: string
    label: Packet Port 0 IP Address
    description: IP address for pkt0 port
    default : 10.34.226.40

  pkt1IPAddress:
    type: string
    label: Packet Port 1 IP Address
    description: IP address for pkt1 port
    default : 10.34.227.40

####################################
# Netmask for each Non-DHCP networks
####################################
  mgt0SubnetPrefix:
    type: string
    label: Management Port 0 Subnet Prefix
    description: Subnet Prefix for mgt0 port
    default : 24

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #mgt1SubnetPrefix:
  #  type: string
  #  label: Management Port 1 Subnet Prefix
  #  description: Subnet Prefix for mgt1 port
  #  default : None

  ha0SubnetPrefix:
    type: string
    label: High Availability Port Subnet Prefix
    description: Subnet Prefix for ha0 port
    default : 24

  pkt0SubnetPrefix:
    type: string
    label: Packet Port 0 Subnet Prefix
    description: Subnet Prefix for pkt0 port
    default : 24

  pkt1SubnetPrefix:
    type: string
    label: Packet Port 1 Subnet Prefix
    description: Subnet Prefix for pkt1 port
    default : 24

###############################
# Non DHCP Network's gateway IP
###############################

  mgt0Gateway:
    type: string
    label: Management Port 0 Gateway IP
    description: Gateway IP Address for mgt0 port
    default : 10.34.224.1

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #mgt1Gateway:
  #  type: string
  #  label: Management Port 1 Gateway IP
  #  description: Gateway IP Address for mgt1 port
  #  default : None

  ha0Gateway:
    type: string
    label: High Availability Port Gateway IP
    description: Gateway IP Address for ha0 port
    default : 192.168.20.1

  pkt0Gateway:
    type: string
    label: Packet Port 0 Gateway IP
    description: Gateway IP Address for pkt0 port
    default : 10.34.226.1

  pkt1Gateway:
    type: string
    label: Packet Port 1 Gateway IP
    description: Gateway IP Address for pkt1 port
    default : 10.34.227.1

###############################
# DHCP flags
###############################

  isDhcpEnabledOnMgt0:
    type: string
    label: Is DHCP enabled on Mgt0 Subnet?
    description: Is DHCP enabled on Mgt0 Subnet?
    default : False
    constraints:
      - allowed_values: [True,False]

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #isDhcpEnabledOnMgt1:
  #  type: string
  #  label: Is DHCP enabled on Mgt1 Subnet?
  #  description: Is DHCP enabled on Mgt1 Subnet?
  #  default : False
  #  constraints:
  #    - allowed_values: [True,False]

  isDhcpEnabledOnHa0:
    type: string
    label: Is DHCP enabled on Ha0 Subnet?
    description: Is DHCP enabled on Ha0 Subnet?
    default : False
    constraints:
      - allowed_values: [True,False]

  isDhcpEnabledOnPkt0:
    type: string
    label: Is DHCP enabled on Pkt0 Subnet?
    description: Is DHCP enabled on Pkt0 Subnet?
    default : False
    constraints:
      - allowed_values: [True,False]

  isDhcpEnabledOnPkt1:
    type: string
    label: Is DHCP enabled on Pkt1 Subnet?
    description: Is DHCP enabled on Pkt1 Subnet?
    default : False
    constraints:
      - allowed_values: [True,False]

###############################
# IP Address version
###############################

  mgt0IpVersion:
    type: string
    label: Mgt0 IP Version.
    description: Mgt0 IP Version.
    default : V4
    constraints:
      - allowed_values: [V4,V6]

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #mgt1IpVersion:
  #  type: string
  #  label: Mgt1 IP Version.
  #  description: Mgt1 IP Version.
  #  default : V4
  #  constraints:
  #    - allowed_values: [V4,V6]

  pkt0IpVersion:
    type: string
    label: Pkt0 IP Version.
    description: Pkt0 IP Version.
    default : V4
    constraints:
      - allowed_values: [V4,V6]

  pkt1IpVersion:
    type: string
    label: Pkt1 IP Version.
    description: Pkt1 IP Version.
    default : V4
    constraints:
      - allowed_values: [V4,V6]

###################
# Alternate IP list
###################

  pkt0AdditionalIPs:
    type: comma_delimited_list
    label: comma separated list of alternate IPs for pkt0
    description: comma separated list of alternate IPs for pkt0
    default: ""

  pkt1AdditionalIPs:
    type: comma_delimited_list
    label: comma separated list of alternate IPs for pkt1
    description: comma separated list of alternate IPs for pkt1
    default: ""

###############################
# SBC login credentials
###############################

  adminSshKey:
    type: string
    label: adminSshKey
    description: public key to login to SBC CLI as admin user
    default: "ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA4oGIi+0mRS9Q25ln5/gKe1mmR7cfVuFxRQONVbjq8y+JB0g2T49b1Bf8xRhyhkKgdbIbEWdcmboSpTegt6zM0rz6Yw/73c3NVy60CX47t55GCCFYXxt3uwgRlN/9KX1mETCYOSD5AZ7e9YXvbd6/hUKkK/o8Zrhch9ckR2nVSe0v1wob4MMhmC1e9LV5tvk6zAIdmTWOYcrg0Yd6yHRQbNjlVFpQ147TPGy12+tDytqEW+09DQZqvhuiwSyxk3lBlNJYfCT2VidsS2+MQYD+t2REc65vcq/EvXuyuwpvv/IIjX2BBMCG7fMXkGh0wnIPoHbUCNfq1Zr2JGqZ6D8GIQ=="

  linuxAdminSshKey:
    type: string
    label: linuxAdminSshKey
    description: public key to login to SBC shell as linuxadmin user
    default: "ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA4oGIi+0mRS9Q25ln5/gKe1mmR7cfVuFxRQONVbjq8y+JB0g2T49b1Bf8xRhyhkKgdbIbEWdcmboSpTegt6zM0rz6Yw/73c3NVy60CX47t55GCCFYXxt3uwgRlN/9KX1mETCYOSD5AZ7e9YXvbd6/hUKkK/o8Zrhch9ckR2nVSe0v1wob4MMhmC1e9LV5tvk6zAIdmTWOYcrg0Yd6yHRQbNjlVFpQ147TPGy12+tDytqEW+09DQZqvhuiwSyxk3lBlNJYfCT2VidsS2+MQYD+t2REc65vcq/EvXuyuwpvv/IIjX2BBMCG7fMXkGh0wnIPoHbUCNfq1Zr2JGqZ6D8GIQ=="

  adminPassword:
    type: string
    label: adminPasswordHash
    description: password hash to login to SBC CLI as admin user
    default : ""

  linuxAdminPassword:
    type: string
    label: linuxAdminPasswordHash
    description: password hash to login to SBC shell as linuxadmin user
    default : ""

# Resource definitions for all openstack objects to be configured during
# template execution
resources:

  # Create active vSBC instance
  vSBC_ACTIVE:
    type: OS::Nova::Server
    properties:
      name: { get_param: "OS::stack_name" }
      image: { get_param: image }
      flavor: { get_param: flavor }
      config_drive: True
      availability_zone: {get_param: availability_zone}
      #personality:
        #"baseConfig.cli": {get_file: "RIBBON_BASE_CONFIG.cli"}
        #"baseConfig.cli": {get_file: "http://10.11.12.13/sbcCliFiles/RIBBON_BASE_CONFIG.cli"}

      # Attach previously created network ports to the instance
      networks:
        - port: { get_resource: mgt0_port1 }
        - port: { get_resource: ha0_port1 }
        - port: { get_resource: pkt0_port1 }
        - port: { get_resource: pkt1_port1 }
        #- port: { get_resource: pkt0S_port1 }
        #- port: { get_resource: pkt1S_port1 }
        # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
        #- port: { get_resource: mgt1_port1 }

      # Publish the assigned floating IP addresses with appended subnet mask to the openstack metadata service.
      # Subnet prefix for floating ips not used - hard coded to 32 for consistencey.
      metadata:
        IF0:
             str_replace:
               template: |
                 { "Port": "$port_name",
                   "DHCP": "$dhcp_flag",
                   "GW$ip_version": "$gateway_ip",
                   "IP$ip_version": "$ip_address"
                 }
               params:
                 $port_name:  "Mgt0"
                 $dhcp_flag:  { get_param: isDhcpEnabledOnMgt0}
                 $ip_version: { get_param: mgt0IpVersion }
                 $gateway_ip: { get_param: mgt0Gateway }
                 $ip_address: { list_join: ['/', [ { get_param: mgt0IPAddress }, { get_param: mgt0SubnetPrefix}]] }

        IF1:
             str_replace:
               template: |
                 { "Port": "$port_name",
                   "DHCP": "$dhcp_flag",
                   "GW$ip_version": "$gateway_ip",
                   "IP$ip_version": "$ip_address"
                 }
               params:
                 $port_name:  "Ha0"
                 $dhcp_flag:  { get_param: isDhcpEnabledOnHa0}
                 $ip_version: "V4"
                 $gateway_ip: { get_param: ha0Gateway }
                 $ip_address: { list_join: ['/', [ { get_param: ha0IPAddress }, { get_param: ha0SubnetPrefix}]] }

        IF2:
             str_replace:
               template: |
                 { "Port": "$port_name",
                   "DHCP": "$dhcp_flag",
                   "GW$ip_version": "$gateway_ip",
                   "IP$ip_version": "$ip_address",
                   "VlanId": "$vlan_id"
                 }
               params:
                 $port_name:  "Pkt0"
                 $dhcp_flag:  { get_param: isDhcpEnabledOnPkt0}
                 $ip_version: { get_param: pkt0IpVersion }
                 $gateway_ip: { get_param: pkt0Gateway }
                 $ip_address: { list_join: ['/', [ { get_param: pkt0IPAddress }, { get_param: pkt0SubnetPrefix}]] }
                 $vlan_id:    { get_param: vlanIdPkt0 }

        IF3:
             str_replace:
               template: |
                 { "Port": "$port_name",
                   "DHCP": "$dhcp_flag",
                   "GW$ip_version": "$gateway_ip",
                   "IP$ip_version": "$ip_address",
                   "VlanId": "$vlan_id"
                 }
               params:
                 $port_name:  "Pkt1"
                 $dhcp_flag:  { get_param: isDhcpEnabledOnPkt1}
                 $ip_version: { get_param: pkt1IpVersion }
                 $gateway_ip: { get_param: pkt1Gateway }
                 $ip_address: { list_join: ['/', [ { get_param: pkt1IPAddress }, { get_param: pkt1SubnetPrefix}]] }
                 $vlan_id:    { get_param: vlanIdPkt1 }

        ClusterIp: { get_param: sbc_rgIp}

      #  PKT0_ALT_01: { "IFName": "IF2", "IP": {get_param: [pkt0AdditionalIPs,0]}}
      #  PKT0_ALT_02: { "IFName": "IF2", "IP": {get_param: [pkt0AdditionalIPs,1]}}
      #  PKT1_ALT_01: { "IFName": "IF3", "IP": {get_param: [pkt1AdditionalIPs,0]}}
      #  PKT1_ALT_02: { "IFName": "IF3", "IP": {get_param: [pkt1AdditionalIPs,1]}}

      # METADATA_APPEND_ABOVE
      # Make sure that the indentation is maintained same as the existing
      # metadata elements. Remove only pound sign above. Don't remove spaces.

      # Set the format to RAW to pass data directly as userdata set the floating and virtual IP counts
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
                #cloud-config
                users:
                    - name: admin
                      ssh-authorized-keys:
                                 - $adminSshKey
                      plain_text_passwd: admin
                      lock_passwd: false
                    - name: linuxadmin
                      ssh-authorized-keys:
                                 - $linuxAdminSshKey
                      plain_text_passwd: sonus
                      lock_passwd: false
                    - name: root
                      plain_text_passwd: sonus1
                      lock_passwd: false

                runcmd:
                    - sed -i -e "/^AllowUsers/s/\slinuxadmin\(\s\|$\)/ /g" -e "/^AllowUsers/s/\sroot\(\s\|$\)/ /g" /etc/ssh/sshd_config
                    - sed -i "/^AllowUsers/s/AllowUsers /AllowUsers root linuxadmin /" /etc/ssh/sshd_config
                    - sed -i "/PasswordAuthentication no/s/PasswordAuthentication no/PasswordAuthentication yes/" /etc/ssh/sshd_config
                    - sed -i "/^PermitRootLogin/s/ no/ yes/" /etc/ssh/sshd_config
                    - sed -i "s/allowSshAccess=n/allowSshAccess=y/" /opt/sonus/conf/sbx.conf

                write_files:
                -   content: |
                        {
                          "CEName"                   : "$ce_name",
                          "SystemName"               : "$system_name",
                          "SbcPersonalityType"       : "$personality",
                          "DosSupportSecPktPorts"    : "$dos_support_sec_port",
                          "EmsUsername"              : "$ems_user_name",
                          "EmsPassword"              : "$ems_password",
                          "EmsIP"                    : [ "$ems_ip_1", "$ems_ip_2" ],
                          "EmsDownloadConfig"        : "$downloadConfig",
                          "CERole"                   : "$ce_role",
                          "TemplateName"             : "heatRgNoDhcp.yaml",
                          "TemplateVersion"          : "V07.01.00R000",
                          "EmsPrivateNodeParameters" : { "cluster_id": "$cluster_id","vnfc_id":"$vnfc_id"}
                        }
                    path: /opt/sonus/conf/userData.json

          params:
              $ce_name:        { get_param: sbc_ceName  }
              $system_name:    { get_param: sbc_system_name }
              $personality:    { get_param: personality }
              $dos_support_sec_port:  { get_param: dos_support_sec_port }
              $ems_user_name:  { get_param: ems_user_name }
              $ems_password:   { get_param: ems_password }
              $ems_ip_1:       { get_param: ems_ip_1 }
              $ems_ip_2:       { get_param: ems_ip_2 }
              $cluster_id:     { get_param: cluster_id }
              $downloadConfig: { get_param: download_config }
              $ce_role:        { get_param: sbc_ceRole }
              $vnfc_id:        { list_join: ['-', [ { get_param: "OS::stack_name" }, { get_param: cluster_id }, '1']] }
              $adminSshKey:    { get_param: adminSshKey }
              $linuxAdminSshKey: { get_param: linuxAdminSshKey }
              $adminPassword:    { get_param: adminPassword }
              $linuxAdminPassword: { get_param: linuxAdminPassword }

  # Create the four required virtual nics (ports) to attach to virtual SBC instance 1

  # Private Port Creation.

  mgt0_port1:
    type: OS::Neutron::Port
    properties:
      network: { get_param : provider_network_mgt0 }
      fixed_ips:
        - ip_address: { get_param: mgt0IPAddress}

      # mgt0 EDIT: Below line:
      #   SR-IOV support:    uncomment
      #   No SR-IOV support: comment
      #binding:vnic_type: direct
      security_groups:
        - { get_param: security_group }

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #mgt1_port1:
  #  type: OS::Neutron::Port
  #  properties:
  #    network: { get_param : provider_network_mgt1 }
  #    fixed_ips:
  #      - ip_address: { get_param: mgt1IPAddress}
  #
  #    # mgt1 EDIT: Below line:
  #    #   SR-IOV support:    uncomment
  #    #   No SR-IOV support: comment
  #    #binding:vnic_type: direct
  #    security_groups:
  #      - { get_param: security_group }

  ha0_port1:
    type: OS::Neutron::Port
    properties:
      network: { get_param : provider_network_ha }
      fixed_ips:
        - ip_address: { get_param: ha0IPAddress}

      # ha0 EDIT: Below line:
      #   SR-IOV support:    uncomment
      #   No SR-IOV support: comment
      #binding:vnic_type: direct

  # EDIT_PRIVATE_PORT_CREATION_PKT0
  pkt0_port1:
    type: OS::Neutron::Port
    properties:
      network: { get_param : provider_network_pkt0 }
      fixed_ips:
        - ip_address: { get_param: pkt0IPAddress}
        #- ip_address: {get_param: [pkt0AdditionalIPs,0]}
        #- ip_address: {get_param: [pkt0AdditionalIPs,1]}

      # pkt0 EDIT: Below line:
      #   SR-IOV support:    uncomment
      #   No SR-IOV support: comment
      binding:vnic_type: direct
      security_groups:
        - { get_param: security_group }

  # EDIT_PRIVATE_PORT_CREATION_PKT1
  pkt1_port1:
    type: OS::Neutron::Port
    depends_on: pkt0_port1
    properties:
      network: { get_param : provider_network_pkt1 }
      fixed_ips:
        - ip_address: { get_param: pkt1IPAddress}
        #- ip_address: {get_param: [pkt1AdditionalIPs,0]}
        #- ip_address: {get_param: [pkt1AdditionalIPs,1]}

      # pkt1 EDIT: Below line:
      #   SR-IOV support:    uncomment
      #   No SR-IOV support: comment
      binding:vnic_type: direct
      security_groups:
        - { get_param: security_group }

  # EDIT_PRIVATE_PORT_CREATION_PKT0S_START
  #pkt0S_port1:
    #type: OS::Neutron::Port
    #depends_on: pkt1_port1
    #properties:
      #network: { get_param : provider_network_pkt0_standby }
      #binding:vnic_type: direct
      #security_groups:
        #- { get_param: security_group }

  # EDIT_PRIVATE_PORT_CREATION_PKT0S_END

  # EDIT_PRIVATE_PORT_CREATION_PKT1S_START
  #pkt1S_port1:
    #type: OS::Neutron::Port
    #depends_on: pkt0S_port1
    #properties:
      #network: { get_param : provider_network_pkt1_standby }
      #binding:vnic_type: direct
      #security_groups:
        #- { get_param: security_group }

  # EDIT_PRIVATE_PORT_CREATION_PKT1S_END


# output some stuff for debug
outputs:
  instance_name:
    description: Name of the instance
    value: { get_attr: [vSBC_ACTIVE, name] }
