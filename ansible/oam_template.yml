heat_template_version: 2015-04-30
description: Template to setup and deploy a Standalone vSBC compute instances
#######################################################################
# Sample Environment content to be sourced
#
#parameters:
#
#  # System Settings
#  image:           myImage
#  flavor:          cloudSBC.lite
#  security_group:  vSBC_security_group
#
#  # External Network Settings
#  mgt0_ext_network: ext_net
#
#  # Private Network Settings
#  private_network_mgt0: mgt0
#  private_network_ha:   ha0
#  private_network_pkt0: pkt0
#  private_network_pkt1: pkt1
#
#  # Private Subnet Settings
#  private_subnet_mgt0: mgt0_subnet
#  private_subnet_ha:   ha0_subnet
#  private_subnet_pkt0: pkt0_subnet
#  private_subnet_pkt1: pkt1_subnet
#
###########################################################################

# Parameters required from user or upstream application/orchestration to setup 
# and launch Standalone vSBC compute instances

parameter_groups:
- label: System Settings
  description: System Level Settings
  parameters:
  - image
  - flavor
  - security_group
  - sbc_system_name
  - personality
  - availability_zone
  
- label: mgt0 DHCP Settings
  description: DHCP Settings for Management Port
  parameters:
  - mgt0IPAddress
  - mgt0SubnetPrefix
  - mgt0Gateway
  - isDhcpEnabledOnMgt0

- label: ha0 DHCP Settings
  description: DHCP Settings for High Availability Port
  parameters:
  - ha0IPAddress
  - ha0SubnetPrefix
  - ha0Gateway
  - isDhcpEnabledOnHa0

#- label: External Network Settings
#  description: External Network Settings
#  parameters:
#  - mgt0_ext_network
#  - floating_ip_count_mgt0

- label: Private Network Settings
  description: External Network Settings
  parameters:
  - private_network_mgt0
  - private_network_ha
  - private_network_pkt0
  - private_network_pkt1

- label: Private Subnet Settings
  description: Subnet Settings
  parameters:
  - private_subnet_mgt0
  - private_subnet_ha
  - private_subnet_pkt0
  - private_subnet_pkt1


- label: Instance Specific Settings
  description: Instance Specific Settings
  parameters:
  - sbc_ceName
  - sbc_ceRole
  - sbc_rgIp 

- label: EMS Settings
  description: EMS Settings
  parameters:
  - ems_user_name
  - ems_password
  - ems_ip_1
  - ems_ip_2
  - cluster_id
  - download_config
  
#- label: OAM Settings
#  description: OAM Settings
#  parameters:
#  - oam_ip_1
#  - oam_ip_2

 
parameters:

############################
# System Level Settings
############################

  image:
    type: string
    label: Image Name 
    description: Image to be used for launching the instance(s)
    constraints:
      - custom_constraint: 'glance.image'

  flavor:
    type: string
    label: Flavor
    description: Flavor to be used for instance(s)
    constraints:
      - custom_constraint: 'nova.flavor'
  availability_zone:
    type: string
    label: Zone
    default: "ansible"
    description: Zone to be used for instance(s)
    
  security_group:
    type: string
    label: Security Group
    description: Security group of instance(s)

  sbc_system_name:
    type: string
    label: SBC System Name
    description: SBC system name
    default: "oamsbc"
    constraints:
      - length: { min: 0, max: 26 }
        description: "Enter valid system name. Length of this string should be less than 26"
      - allowed_pattern: "^[A-Za-z]{1}[-A-Za-z0-9]*[A-Za-z0-9]{1}$"
        description: "Enter valid system name. Regex: ^[A-Za-z]{1}[-A-Za-z0-9]*[A-Za-z0-9]{1}$ "

  personality:
    type: string
    label: SBC Personality Type
    description: Configures SBC instance to be Signaling,Media or Integrated node.
    default: ssbc
    constraints:
      - allowed_values: [ssbc,msbc,isbc,mrfp]

############################
# External Network Settings
############################

#  mgt0_ext_network:
#    type: string
#    label: Management Port Public Network Name or ID
#    description: Public network with floating IP addresses for mgt0 (used only if "Floating IP Count" is non-zero for mgt0).
#    default: "None"
#    constraints:
#      - custom_constraint: 'neutron.network'

#############################
# Setting up the count values
#############################

  floating_ip_count_mgt0:
    type: number 
    label: Number of Floating IPs on mgt0
    description: Number of public IPs on mgt0.
    default: 0 
    constraints:
      - range: { min: 0, max: 1 }

############################
# Private Network Settings
############################

  private_network_mgt0:
    type: string
    label: Management Port Private Network Name or ID
    description: Name/ID of private network for mgt0.
    default: "PR_MGMT"
    constraints:
      - custom_constraint: 'neutron.network'

  private_network_ha:
    type: string
    label: HA Port Private Network Name or ID
    description: Name/ID of private network for ha0.
    default: "ha"
    constraints:
      - custom_constraint: 'neutron.network'

  private_network_pkt0:
    type: string
    label: Packet Port 0 Private Network Name or ID
    description: Name/ID of private network for pkt0.
    default: "sriov_pkt0"
    constraints:
      - custom_constraint: 'neutron.network'

  private_network_pkt1:
    type: string
    label: Packet Port 1 Private Network Name or ID
    description: Name/ID of private network for pkt1.
    default: "sriov_pkt1"
    constraints:
      - custom_constraint: 'neutron.network'

############################
# Private Subnet Settings
############################

  private_subnet_mgt0:
    type: string
    label: Management Port Private Subnet Name or ID
    description: Name/ID of private subnet for mgt0.
    default: "8b9fd482-9528-4abe-9b2b-0ea41e100a76"

  private_subnet_ha:
    type: string
    label: HA Port Private Subnet Name or ID
    description: Name/ID of private subnet for ha0.
    default: "dd7bf466-7db4-4217-be2b-acf81a25c30e"

  private_subnet_pkt0:
    type: string
    label: Packet Port 0 Private Subnet Name or ID
    description: Name/ID of private subnet for pkt0.
    default: "d7610360-687b-4211-8316-b90f45e2e6b5"

  private_subnet_pkt1:
    type: string
    label: Packet Port 1 Private Subnet Name or ID
    description: Name/ID of private subnet for pkt1.
    default: "810604b7-4de4-4c06-9751-4ef5123d38f8"

############################
# Instance Specific Settings
############################
  sbc_ceName:
    type: string
    label: SBC (Assigned) Active Instance Name (Mandatory parameter)
    description: SBC active instance name.
    default: "oam"
    constraints:
      - length: { min: 0, max: 63 }
        description: "Enter valid active instance name. Length of this string should be less than 63"
      - allowed_pattern: "^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$"
        description: "Enter valid active instance name. Regex: ^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$ "

  sbc_ceRole:
    type: string
    label: SBC Configured CE Role
    description: SBC Configured CE Role.
    default: "ACTIVE"
    constraints:
      - length: { min: 0, max: 8 }
        description: "Enter valid instance role. Role can be ACTIVE or STANDBY"
      - allowed_pattern: "^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$"
        description: "Enter valid instance role. Regex: ^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$ "
      - allowed_values: [ACTIVE,STANDBY]

  sbc_rgIp:
    type: string
    label: HA port IP address of one of the members of SBC Redundancy Group(RG). (Note - Provide 169.254.88.1 for the first node of RG)
    description: SBC RG is formed by communicating over the provided IP. When adding 3rd or subsequent instance to RG, can provide HA IP of any of the instances that are up and running.
    default: "192.168.2.113"
    constraints:
      - length: { min: 0, max: 63 }
        description: "Enter valid IP."
      - allowed_pattern: "^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$"
        description: "Enter valid cluster IP. Regex: ^(?:[0-9]{1,3}\\.){3}[0-9]{1,3}$"

################
# EMS Settings
################
  ems_user_name:
    type: string
    label: EMS User Name
    description: User name for registering with EMS
    default: restuser

  ems_password:
    type: string
    label: EMS Password
    description: EMS registration password
    hidden: true
    default: sonus123

  ems_ip_1:
    type: string
    label: EMS IP 1
    description: EMS IP Address 1 - e.g. 10.52.13.40 (No quotes required)
    default: "10.54.8.108"

  ems_ip_2:
    type: string
    label: EMS IP 2
    description: EMS IP Address 2 - e.g. 51.12.30.24 (No quotes required)
    default: ""

  cluster_id:
    type: string
    label: Cluster ID
    description: Cluster/VNF ID value from EMS Cluster Mgmt.
    default: "SSBCTEST"

  download_config:
    type: string
    label: Download Configuration from EMS
    description: Download Configuration from EMS
    default: True
    constraints:
      - allowed_values: [True,False]

  # oam_ip_1:
    # type: string
    # label: OAM IP 1
    # description: OAM IP Address 1 - e.g. 10.52.13.40 (No quotes required)
    # default: ""

  # oam_ip_2:
    # type: string
    # label: OAM IP 2
    # description: OAM IP Address 2 - e.g. 10.52.13.40 (No quotes required)
    # default: ""

     

##################################
# IP address of the Non-DHCP ports
##################################
  mgt0IPAddress:
    type: string
    label: Management Port IP Address
    description: IP address for mgt0 port
    default : "10.34.224.113"

  ha0IPAddress:
    type: string
    label: High Availability Port IP Address
    description: IP address for ha0 port
    default : "192.168.2.113"


####################################
# Netmask for each Non-DHCP networks
####################################
  mgt0SubnetPrefix:
    type: string
    label: Management Port Subnet Prefix
    description: Subnet Prefix for mgt0 port
    default : "24"

  ha0SubnetPrefix:
    type: string
    label: High Availability Port Subnet Prefix
    description: Subnet Prefix for ha0 port
    default : "24"

###############################
# Non DHCP Network's gateway IP
###############################

  mgt0Gateway:
    type: string
    label: Management Port Gateway IP
    description: Gateway IP Address for mgt0 port
    default : "10.34.224.1"

  ha0Gateway:
    type: string
    label: High Availability Port Gateway IP
    description: Gateway IP Address for ha0 port
    default : "192.168.2.1"

###############################
# DHCP flags
###############################

  isDhcpEnabledOnMgt0:
    type: string
    label: Is DHCP enabled on Mgt0 Subnet?
    description: Is DHCP enabled on Mgt0 Subnet?
    default : False
    constraints:
      - allowed_values: [True,False]

  isDhcpEnabledOnHa0:
    type: string
    label: Is DHCP enabled on Ha0 Subnet?
    description: Is DHCP enabled on Ha0 Subnet?
    default : False
    constraints:
      - allowed_values: [True,False]

  isDhcpEnabledOnPkt0:
    type: string
    label: Is DHCP enabled on Pkt0 Subnet?
    description: Is DHCP enabled on Pkt0 Subnet?
    default : False
    constraints:
      - allowed_values: [True,False]

  isDhcpEnabledOnPkt1:
    type: string
    label: Is DHCP enabled on Pkt1 Subnet?
    description: Is DHCP enabled on Pkt1 Subnet?
    default : False
    constraints:
      - allowed_values: [True,False]

# Resource definitions for all openstack objects to be configured during 
# template execution
resources:

  # Create active vSBC instance
  vSBC_ACTIVE:
    type: OS::Nova::Server
    properties:
      name: { get_param: "OS::stack_name" }
      image: { get_param: image }
      flavor: { get_param: flavor }
      config_drive: True
      availability_zone: { get_param: availability_zone }
      
      # Attach previously created network ports to the instance
      networks:
        - port: { get_resource: mgt0_port1 }
        - port: { get_resource: ha0_port1 }
        - port: { get_resource: pkt0_port1 }
        - port: { get_resource: pkt1_port1 }

      # Publish the assigned floating IP addresses with appended subnet mask to the openstack metadata service.
      # Subnet prefix for floating ips not used - hard coded to 32 for consistencey.
      metadata:
        IF0: { "Port":  "Mgt0",
               "DHCP":  { get_param: isDhcpEnabledOnMgt0 },
               "GWV6":  { get_param: mgt0Gateway }, 
               "IPV6":  { list_join: ['/', [ { get_attr: [mgt0_port1, fixed_ips, 0, ip_address] }, { get_param: mgt0SubnetPrefix}]] },

             }
        IF1: { "Port": "Ha0",
               "DHCP": {get_param: isDhcpEnabledOnHa0},
               "GWV4": { get_param: ha0Gateway },  
               "IPV4": { list_join: ['/', [ { get_attr: [ha0_port1, fixed_ips, 0, ip_address] }, { get_param: ha0SubnetPrefix}]] }
             }
        IF2: { "Port": "Pkt0",
               "DHCP": "False"
             }
        IF3: { "Port":"Pkt1", 
               "DHCP": "False"
             }

        ClusterIp: { get_param: sbc_rgIp}

      # Set the format to RAW to pass data directly as userdata set the floating and virtual IP counts
      user_data_format: RAW
      user_data:
        str_replace:
          template: 
                #cloud-config
                ### USER EDITABLE SECTION FOR SSH KEYS ###
                users:
                    - name: admin
                      plain_text_passwd: 
                      ssh-authorized-keys:
                        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDP8yPXPoZNnpSJg7td8out5OrOBlH76u+CLyZV6Vh/7Z3C4cPbLvIPiJwa8qHCaqH3lZClq+iYLCxezMdiVKjQozCWaPnBIaognmBnlGftT9Ur9aN6A8vK6pgifNmJNXyv+6lDu1HJEKZoFplkz4xzplgyJyPe9ce88BeeI80NZ+JReCInnPR8FIjni/ZOZqRSmyavcnU1zvINRiiRzNUGpRWgVPuAPfFe3PhHsO54ARm/euBZG18iavIWUUywA0I5PQ8/gRkmkNDDtgFZFwW1ySwpdzLpv/5tTft+wVW5zxi1Omm8+nvLBtGP9MVDD8IC32vhH9FlIQUBPjOaNqSV absharma@bats16
                        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDP8yPXPoZNnpSJg7td8out5OrOBlH76u+CLyZV6Vh/7Z3C4cPbLvIPiJwa8qHCaqH3lZClq+iYLCxezMdiVKjQozCWaPnBIaognmBnlGftT9Ur9aN6A8vK6pgifNmJNXyv+6lDu1HJEKZoFplkz4xzplgyJyPe9ce88BeeI80NZ+JReCInnPR8FIjni/ZOZqRSmyavcnU1zvINRiiRzNUGpRWgVPuAPfFe3PhHsO54ARm/euBZG18iavIWUUywA0I5PQ8/gRkmkNDDtgFZFwW1ySwpdzLpv/5tTft+wVW5zxi1Omm8+nvLBtGP9MVDD8IC32vhH9FlIQUBPjOaNqSV absharma@bats16
                    - name: linuxadmin1
                      ssh-authorized-keys:
                        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDP8yPXPoZNnpSJg7td8out5OrOBlH76u+CLyZV6Vh/7Z3C4cPbLvIPiJwa8qHCaqH3lZClq+iYLCxezMdiVKjQozCWaPnBIaognmBnlGftT9Ur9aN6A8vK6pgifNmJNXyv+6lDu1HJEKZoFplkz4xzplgyJyPe9ce88BeeI80NZ+JReCInnPR8FIjni/ZOZqRSmyavcnU1zvINRiiRzNUGpRWgVPuAPfFe3PhHsO54ARm/euBZG18iavIWUUywA0I5PQ8/gRkmkNDDtgFZFwW1ySwpdzLpv/5tTft+wVW5zxi1Omm8+nvLBtGP9MVDD8IC32vhH9FlIQUBPjOaNqSV absharma@bats16
                        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDP8yPXPoZNnpSJg7td8out5OrOBlH76u+CLyZV6Vh/7Z3C4cPbLvIPiJwa8qHCaqH3lZClq+iYLCxezMdiVKjQozCWaPnBIaognmBnlGftT9Ur9aN6A8vK6pgifNmJNXyv+6lDu1HJEKZoFplkz4xzplgyJyPe9ce88BeeI80NZ+JReCInnPR8FIjni/ZOZqRSmyavcnU1zvINRiiRzNUGpRWgVPuAPfFe3PhHsO54ARm/euBZG18iavIWUUywA0I5PQ8/gRkmkNDDtgFZFwW1ySwpdzLpv/5tTft+wVW5zxi1Omm8+nvLBtGP9MVDD8IC32vhH9FlIQUBPjOaNqSV absharma@bats16
                      sudo: ['ALL=(ALL) NOPASSWD:ALL']
                      groups: sudo
                    - name: linuxadmin
                      plain_text_passwd: sonus
                      lock_passwd: false
                      ssh-authorized-keys:
                        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDP8yPXPoZNnpSJg7td8out5OrOBlH76u+CLyZV6Vh/7Z3C4cPbLvIPiJwa8qHCaqH3lZClq+iYLCxezMdiVKjQozCWaPnBIaognmBnlGftT9Ur9aN6A8vK6pgifNmJNXyv+6lDu1HJEKZoFplkz4xzplgyJyPe9ce88BeeI80NZ+JReCInnPR8FIjni/ZOZqRSmyavcnU1zvINRiiRzNUGpRWgVPuAPfFe3PhHsO54ARm/euBZG18iavIWUUywA0I5PQ8/gRkmkNDDtgFZFwW1ySwpdzLpv/5tTft+wVW5zxi1Omm8+nvLBtGP9MVDD8IC32vhH9FlIQUBPjOaNqSV absharma@bats16
                        - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDP8yPXPoZNnpSJg7td8out5OrOBlH76u+CLyZV6Vh/7Z3C4cPbLvIPiJwa8qHCaqH3lZClq+iYLCxezMdiVKjQozCWaPnBIaognmBnlGftT9Ur9aN6A8vK6pgifNmJNXyv+6lDu1HJEKZoFplkz4xzplgyJyPe9ce88BeeI80NZ+JReCInnPR8FIjni/ZOZqRSmyavcnU1zvINRiiRzNUGpRWgVPuAPfFe3PhHsO54ARm/euBZG18iavIWUUywA0I5PQ8/gRkmkNDDtgFZFwW1ySwpdzLpv/5tTft+wVW5zxi1Omm8+nvLBtGP9MVDD8IC32vhH9FlIQUBPjOaNqSV absharma@bats16
                runcmd:
                        - sed -i "/^AllowUsers/s/AllowUsers /AllowUsers linuxadmin /" /etc/ssh/sshd_config
                #cloud-config
                write_files:
                -   content: 
                        {
                          "CERole"                   : "$ce_role",
                          "CEMode"                   : "oam",
                          "CEName"                   : "$ce_name",
                          "SystemName"               : "$system_name",
                          "SbcPersonalityType"       : "$personality",
                          "SbcMgmtMode"              : "distributed",
                          "EmsUsername"              : "$ems_user_name",
                          "EmsPassword"              : "$ems_password",
                          "EmsIP"                    : [ "$ems_ip_1", "$ems_ip_2" ],
                          "EmsDownloadConfig"        : "$downloadConfig",
                          "TemplateName"             : "heatOamNoDhcp.yaml",
                          "TemplateVersion"          : "TEMPLATE_VERSION_UNKNOWN",
#                          "OamIP"                    : [ "$oam_ip_1","$oam_ip_2"],
#                          "Oam1Ip"                   : "$oam_ip_1",
#                          "Oam2Ip"                   : "$oam_ip_2",                          
                          "EmsPrivateNodeParameters" : { "cluster_id": "$cluster_id","vnfc_id":"$vnfc_id"}
                        }
                    path: /opt/sonus/conf/userData.json

          params:
              $ce_role:          { get_param: sbc_ceRole }
              $ce_name:          { get_param: sbc_ceName  }
              $system_name:      { get_param: sbc_system_name }
              $personality:      { get_param: personality }
              $ems_user_name:    { get_param: ems_user_name }
              $ems_password:     { get_param: ems_password }
              $ems_ip_1:         { get_param: ems_ip_1 }
              $ems_ip_2:         { get_param: ems_ip_2 }
              $cluster_id:       { get_param: cluster_id }
              $downloadConfig:   { get_param: download_config }
              $vnfc_id:          { list_join: ['-', [ { get_param: "OS::stack_name" }, { get_param: cluster_id }, '1']] }
#              $oam_ip_1:         { get_param: oam_ip_1 }
#              $oam_ip_2:         { get_param: oam_ip_2 }


  # Create the four required virtual nics (ports) to attach to virtual SBC instance 1
  mgt0_port1:
    type: OS::Neutron::Port
    properties:
      network: { get_param : private_network_mgt0 }
      fixed_ips:
        - ip_address: { get_param: mgt0IPAddress }
      security_groups:
        - { get_param: security_group }

  ha0_port1:
    type: OS::Neutron::Port
    properties:
      network: { get_param : private_network_ha }
      fixed_ips:
        - ip_address: { get_param: ha0IPAddress}

  pkt0_port1:
    type: OS::Neutron::Port
    properties:
      network: { get_param : private_network_pkt0 }


        # pkt0 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
        #- subnet: { get_param: private_subnet_pkt0}

      # pkt0 EDIT: uncomment below line to DISABLE SR-IOV support or comment to
      # enable it
      binding:vnic_type: direct

      security_groups:
        - { get_param: security_group }


  pkt1_port1:
    type: OS::Neutron::Port
    properties:
      network: { get_param : private_network_pkt1 }
         #- ip_address: {get_param: [pkt1_alt_ips,0]}
        #- ip_address: {get_param: [pkt1_alt_ips,1]}

        # pkt1 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
        #- subnet: { get_param: private_subnet_pkt1}

      # pkt1 EDIT: uncomment below line to DISABLE SR-IOV support or comment to
      # enable it
      binding:vnic_type: direct

      security_groups:
        - { get_param: security_group }


  # Create and associate three floating IP addresses to the mgt0, pkt0 and pkt1 ports of instance 1

# output some stuff for debug

outputs:
  instance_name:
    description: Name of the instance
    value: { get_attr: [vSBC_ACTIVE, name] }

  mgt0_ip_out:
    description: MGT0 V4/V6
    value: { get_param: [mgt0IPAddress]}


