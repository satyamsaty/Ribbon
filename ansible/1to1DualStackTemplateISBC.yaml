heat_template_version: 2014-10-16
description: Template to setup and deploy a 1x1 HA vSBC compute instances
##################################################################################################
# IMPORTANT NOTE to configure second management port 'mgt1': 
# 
#  1. By Default, configuration of second management port is commented out in this template.
# 
#  2. To enable configuration of second management port 'mgt1', search for the following tag and follow the instructions with the tag:
#     Tag to search : 'MGT1_EDIT'
#
#  3. Add the entries for second management port 'mgt1' in userdata/metadata section of each instance corressponding to the entries 
#     that are already there for 'mgt0' interface.
#
#     For example:
#      In metadata section: add the IF metadata and LOGICAL_MGMT_IP related data for second management port like:
#
#        IF4: { "Port":"Mgt1",
#               "DHCP":  { get_param: isDhcpEnabledOnMgt1},
#               "GWV4":  { get_param: [ mgt1Gateway, 0] },
#               "IPV4":  { list_join: ['/', [ { get_param: [ mgt1IPAddressStandby, 0] }, { get_param: [ mgt1SubnetPrefix, 0] }]] },
#               "GWV6":  { get_param: [ mgt1Gateway, 1] },
#               "IPV6":  { list_join: ['/', [ { get_param: [ mgt1IPAddressStandby, 1] }, { get_param: [ mgt1SubnetPrefix, 1] }]] },
#             }
#       
#        LOGICAL_MGMT_IP_1: { "IFName": "IF4", 
#                           "IPV4": { get_param: [logicalManagementIpAddress_1, 0] }, 
#                           "IPV6": { get_param: [logicalManagementIpAddress_1, 1] } 
#                         }
#
#      And in 'write_files' under userdata section, add the peer's second management port entries like:
#
#                          "PeerCEMgt0IPv4Prefix"    : "$peer_ipv4_prefix_mgt0",
#                          "PeerCEMgt0IPv4Address"   : "$peer_ipv4_mgt0",
#                          "PeerCEMgt0IPv6Prefix"    : "$peer_ipv6_prefix_mgt0",
#                          "PeerCEMgt0IPv6Address"   : "$peer_ipv6_mgt0",
#                          "PeerCEMgt1IPv4Prefix"    : "$peer_ipv4_prefix_mgt1",
#                          "PeerCEMgt1IPv4Address"   : "$peer_ipv4_mgt1",
#                          "PeerCEMgt1IPv6Prefix"    : "$peer_ipv6_prefix_mgt1",
#                          "PeerCEMgt1IPv6Address"   : "$peer_ipv6_mgt1",
#
# NOTE: Please read the below instructions before using this template,
#       it may need some edits depending on the usecase(s).
#       This template assumes ALL the interfaces are non-DHCP and with the instructions in-line
#       it can be tailored to make some interfaces use DHCP and/or SR-IOV.
#
# 1. By Default, DHCP is disabled on all the interfaces
#
# 2. To Enable/Disable DHCP or SR-IOV on any interface, search for '<interfaceName> EDIT:'
#    and follow instructions there
#
#    E.g. To Enable DHCP on Packet Port 0 (pkt0):
#         Search for: 'pkt0 EDIT:' (without quotes)
#         (Replace pkt0 with mgt0, ha0 or pkt1 as applicable)
#
#    Sample code segment:
#        # pkt0 EDIT: uncomment below line to DISABLE DHCP or comment to ENABLE DHCP
#        - ip_address: { get_param: pkt0IPAddress}
#
#        # pkt0 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
#        #- subnet: { get_param: private_subnet_pkt0}
#
#      # pkt0 EDIT: uncomment below line to ENABLE SR-IOV support or comment to disable it
#      #binding:vnic_type: direct
#
# 3. Additional private IPs and/or floating IPs will be queried by the template when launched as a comma-separeted input. 
#    These IP addresses will be queried inside template at multiple places, and the procedure for the same is given in next point.
#    Make sure that the comma-separated input doesn't have spaces between them. That would lead to template-load error.
#
# 4. Procedure for adding additional IP address to ports.
#
#    This involves the following steps which are described in detail below:
#       - Private port creation, virtual port creation, floating IP creation and
#         meta data updates.
#
#    Procedure:
#
#    a) Search for the tag "EDIT - VIP PORT CREATION"
#       * Add additional IP address to the PKT ports by uncommenting out
#         "- ip_address:" parameters and query the IP address from the list input as give below:
#
#         - ip_address: {get_param: [pkt0_vips,0]}
#
#       * Repeat this multiple times based on number
#         of IP addresses to be assigned to the port
#
#    b) Search for the tag "EDIT - PRIVATE PORT CREATION - ACTIVE"
#       * Add the IP address created in the above steps in the
#         "allowed_address_pairs" section of corresponding PKT port by
#         uncommenting the "- ip_address:" section as shown below:
#
#         - ip_address: {get_param: [pkt0_vips,0]}
#
#       * Repeat the process for all the IP addresses assigned to the
#         corresponding VIP port in step 4.a
#       
#     c) Search for the tag "EDIT - PRIVATE PORT CREATION - STANDBY"
#        * Repeat the same process as explained in section 4.b
#
#     d) Optional : Adding Floating IP to the additional IP address created
#        above.
#
#        * Search for the tag "ADD - ADDITIONAL FLOATING IP CREATION"
#        * Create the Floating IP as shown below:
#
#          pktX_floating_ip_A:
#            type: OS::Neutron::FloatingIP
#            properties:
#              floating_network: { get_param: pktX_ext_network }
#              port_id: { get_resource: pktX_vip_port }
#              fixed_ip_address: {get_param: [pktX_vips,Y]}
#              floating_ip_address: {get_param: [additional_Fips_pktX,Z]}
#
#        * Where:
#          - X can be 0 or 1.
#          - Y can be 0 to n-1, where, n is number of IPs given in the comma 
#            separated list pktX_alt_ips.
#          - Z can be 0 to m-1, where, m is number of IPs given in the comma separated list additional_Fips_pktX.
#          - "pktX_floating_ip_A" is the resource name. Make sure it is unique and
#            not repeated.
#
#        * Comment out the "floating_ip_address" section here if you want Floating IP 
#          to be assigned from floating IP pool automatically
#
#        * Please note, DO NOT PUT TABS, use 2 spaces instead.
#
#     e) Appending Metadata content of ACTIVE and STANDBY server above the
#         section METADATA_APPEND_ABOVE.
#         * With Floating IP : 
#           ALT_PKTX_01: { "IFName": "YYY", "IP": {get_param: [pktX_vips,0]}, "FIPV4": { get_attr: [pktX_floating_ip_A, floating_ip_address] } }
#
#         * Without Floating IP:
#           ALT_PKTX_01: { "IFName": "YYY", "IP": {get_param: [pktX_vips,0]}}
#
#         * Where:
#          - X can be 0 or 1.
#          - ALT_PKTX_01 can be replaced with any valid name for alternate IP.
#          - YYY is the corresponding IF name of PKT port. Eg: IF2 for Pkt0
#          - "pktX_floating_ip_A" is the Public IP resource name , created in step 4.d.
#           
#
# 5. Sample Environment content to be sourced with this template:
#
#    parameters:
#
#      # System Settings
#      image:           myImage
#      flavor:          cloudSBC.lite
#      security_group:  vSBC_security_group
#
#      # External Network Settings
#      mgt0_ext_network: ext_net
#      mgt1_ext_network: ext_net
#      pkt0_ext_network: ext_net
#      pkt1_ext_network: ext_net
#
#      # Private Network Settings
#      private_network_mgt0: mgt0
#      private_network_mgt1: mgt1
#      private_network_ha:   ha0
#      private_network_pkt0: pkt0
#      private_network_pkt1: pkt1
#
#      # Private Subnet Settings
#      private_subnet_mgt0: mgt0_subnet
#      private_subnet_mgt1: mgt1_subnet
#      private_subnet_ha:   ha0_subnet
#      private_subnet_pkt0: pkt0_subnet
#      private_subnet_pkt1: pkt1_subnet
#
#      # Below lines are optional in enviroment file. You can provide the IP
#      # address here
#
#      # MGT0 subnet description
#      mgt0Gateway:
#      mgt0SubnetPrefix:
#
#      # MGT1 subnet description
#      mgt1Gateway:
#      mgt1SubnetPrefix:
#
#      # HA0 subnet description
#      ha0Gateway:
#      ha0SubnetPrefix:
#
#      # PKT0 subnet description
#      pkt0Gateway:
#      pkt0SubnetPrefix:
#      vlanIdPkt0:
#
#      # PKT1 subnet description
#      pkt1Gateway:
#      pkt1SubnetPrefix:
#      vlanIdPkt1:
#
#      # ACTIVE server port's IP address
#      mgt0IPAddressActive:
#      mgt1IPAddressActive:
#      ha0IPAddressActive:
#      pkt0IPAddressActive:
#      pkt1IPAddressActive:
#
#      # STANDBY server port's IP address
#      mgt0IPAddressStandby:
#      mgt1IPAddressStandby:
#      ha0IPAddressStandby:
#      pkt0IPAddressStandby:
#      pkt1IPAddressStandby:
#
#      # VIRTUAL port's IP address
#      logicalManagementIpAddress:
#      logicalManagementIpAddress_1:
#      pkt0VirtualIpAddress:
#      pkt1VirtualIpAddress:
#
#      # Alternate IP addresses
#      pkt0_vips:
#      pkt1_vips:
#      additional_Fips_pkt0:
#      additional_Fips_pkt1:
#
# 6. To provide multiple EMS IP address, follow the instruction given below:
#    1. Remove the quotes from the variable "$ems_ip" in the line 827 and 957.
#    2. Provide the EMS IPs to the template input as: ["a.b.c.d", "p.q.r.s"]
#
# 7. While entering the input parameters to this template, please provide the
#    parameters in the following manner:
#    a) For any IP address field : <IPv4 address>,<IPv6 address>
#       Eg : 10.0.0.221,fd00:10:6b50:4350::69
#    b) Same rule goes for Gateway field.
#    c) For Subnet prefix field: <IPv4 Prefix>,<IPv6 prefix>
#       Eg : 24,60
#
##################################################################################################

parameter_groups:
- label: System Settings
  description: System Level Settings
  parameters:
  - image
  - flavor
  - security_group
  - sbc_system_name
  - personality
  - sbc_ceMode
  - ha_mode

- label: Instance Specific Settings
  description: Instance Specific Settings
  parameters:
  - sbc_active_name
  - sbc_standby_name

- label: External Network Settings
  description: External Network Settings
  parameters:
  - mgt0_ext_network
  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #- mgt1_ext_network
  - pkt0_ext_network
  - pkt1_ext_network
  - floating_ip_count_mgt0
  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #- floating_ip_count_mgt1
  - enable_logical_management_ip
  - enable_logical_management_ip_1
  - floating_ip_count_pkt0
  - floating_ip_count_pkt1

- label: Enable Reverse NAT
  description: Enable reverse nat for ports
  parameters:
  - reverse_nat_pkt0
  - reverse_nat_pkt1

- label: Private Network Settings
  description: External Network Settings
  parameters:
  - private_network_mgt0
  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #- private_network_mgt1
  - private_network_ha
  - private_network_pkt0
  - private_network_pkt1

- label: Private Subnet Settings
  description: Subnet Settings
  parameters:
  - private_subnet_mgt0
  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #- private_subnet_mgt1
  - private_subnet_ha
  - private_subnet_pkt0
  - private_subnet_pkt1

- label: MGT0 Subnet Gateway and Prefix settings
  description: MGT0 Subnet Gateway and Prefix settings
  parameters:
  - isDhcpEnabledOnMgt0
  - mgt0Gateway
  - mgt0SubnetPrefix

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
#- label: MGT1 Subnet Gateway and Prefix settings
#  description: MGT1 Subnet Gateway and Prefix settings
#  parameters:
#  - isDhcpEnabledOnMgt1
#  - mgt1Gateway
#  - mgt1SubnetPrefix

- label: HA0 Subnet Gateway and Prefix settings
  description: HA0 Subnet Gateway and Prefix settings
  parameters:
  - isDhcpEnabledOnHa0
  - ha0Gateway
  - ha0SubnetPrefix

- label: PKT0 Subnet Gateway and Prefix settings
  description: PKT0 Subnet Gateway and Prefix settings
  parameters:
  - isDhcpEnabledOnPkt0
  - pkt0Gateway
  - pkt0SubnetPrefix
  - vlanIdPkt0

- label: PKT1 Subnet Gateway and Prefix settings
  description: PKT1 Subnet Gateway and Prefix settings
  parameters:
  - isDhcpEnabledOnPkt1
  - pkt1Gateway
  - pkt1SubnetPrefix
  - vlanIdPkt1

- label: Active instance IP address settings
  description: Active instance IP address settings
  parameters:
  - mgt0IPAddressActive
  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #- mgt1IPAddressActive
  - ha0IPAddressActive
  - pkt0IPAddressActive
  - pkt1IPAddressActive

- label: Standby instance IP address settings
  description: Standby IP address settings
  parameters:
  - mgt0IPAddressStandby
  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #- mgt1IPAddressStandby
  - ha0IPAddressStandby
  - pkt0IPAddressStandby
  - pkt1IPAddressStandby

- label: Fixed IP address on Virtual Ports
  description: IP address of the Corresponding non-DHCP Virtual Ports
  parameters:
  - logicalManagementIpAddress
  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #- logicalManagementIpAddress_1
  - pkt0VirtualIpAddress
  - pkt1VirtualIpAddress

- label: Alternate IP addresses
  description: Alternate IP addresses
  parameters:
  - pkt0_vips
  - pkt1_vips
  - additional_Fips_pkt0
  - additional_Fips_pkt1

- label: EMS Settings
  description: EMS Settings
  parameters:
  - ems_user_name
  - ems_password
  - ems_ip
  - cluster_id
  - download_config

- label: SBC Login Credentials
  description: SBC Login input - ssh key or password
  parameters:
  - adminSshKey
  - linuxAdminSshKey
  - adminPassword
  - linuxAdminPassword

parameters:

############################
# System Level Settings
############################

  image:
    type: string
    label: Image Name
    description: Image to be used for launching the instance(s)
    default: cSBC_V08.00.00R001
    constraints:
      - custom_constraint: 'glance.image'

  flavor:
    type: string
    label: Flavor
    description: Flavor to be used for instance(s)
    default: ISBC4VCPU
    constraints:
      - custom_constraint: 'nova.flavor'

  security_group:
    type: string
    label: Security Group
    description: Security group of instance(s)
    default: SONUS

  sbc_system_name:
    type: string
    label: SBC System Name
    description: SBC system name
    default: ISBC
    constraints:
      - length: { min: 0, max: 26 }
        description: "Enter valid system name. Length of this string should be less than 26"
      - allowed_pattern: "^[A-Za-z]{1}[-A-Za-z0-9]*[A-Za-z0-9]{1}$"
        description: "Enter valid system name. Regex: ^[A-Za-z]{1}[-A-Za-z0-9]*[A-Za-z0-9]{1}$ "

  personality:
    type: string
    label: SBC Personality Type
    description: Configures SBC instance to be Signaling,Media or Integrated node.
    default: isbc
    constraints:
      - allowed_values: [ssbc,msbc,isbc,mrfp,slb]

  ha_mode:
    type: string
    label: SBC HA Mode
    description: SBC HA Mode, 1 to 1 or N to 1
    default: 1to1
    constraints:
        - allowed_values: [1to1, Nto1]

############################
# External Network Settings
############################

  mgt0_ext_network:
    type: string
    label: Management Port 0 Public Network Name or ID
    description: Public network with floating IP addresses for mgt0 (used only if "Floating IP Count" is non-zero for mgt0).
    default: PR_MGMT
    constraints:
      - custom_constraint: 'neutron.network'

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #mgt1_ext_network:
  #  type: string
  #  label: Management Port 1 Public Network Name or ID
  #  description: Public network with floating IP addresses for mgt1 (used only if "Floating IP Count" is non-zero for mgt1).
  #  constraints:
  #    - custom_constraint: 'neutron.network'

  pkt0_ext_network:
    type: string
    label: Packet Port 0 Public Network Name or ID
    description: Public network with floating IP addresses for pkt0 (used only if "Floating IP Count" is non-zero for pkt0).
    default: sriov_pkt0
    constraints:
      - custom_constraint: 'neutron.network'

  pkt1_ext_network:
    type: string
    label: Packet Port 1 Public Network Name or ID
    description: Public network with floating IP addresses for pkt1 (used only if "Floating IP Count" is non-zero for pkt1).
    default: sriov_pkt1
    constraints:
      - custom_constraint: 'neutron.network'

#############################
# Setting up the count values
#############################

  floating_ip_count_mgt0:
    type: number
    label: Number of Floating IPs on mgt0
    description: Number of public IPs on mgt0.
    default: 0
    constraints:
      - range: { min: 0, max: 1 }

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #floating_ip_count_mgt1:
  #  type: number
  #  label: Number of Floating IPs on mgt1
  #  description: Number of public IPs on mgt1.
  #  default: 0
  #  constraints:
  #    - range: { min: 0, max: 1 }

  enable_logical_management_ip:
    type: number
    label: Number of Floating IP on Logical IPs on mgt0
    description: Number of logical IPs on mgt0.
    default: 0
    constraints:
      - range: { min: 0, max: 1 }

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #enable_logical_management_ip_1:
  #  type: number
  #  label: Number of Floating IP on Logical IPs on mgt1
  #  description: Number of logical IPs on mgt1.
  #  default: 0
  #  constraints:
  #    - range: { min: 0, max: 1 }

  floating_ip_count_pkt0:
    type: number
    label: Number of Floating IPs on pkt0
    description: Number of public IPs on pkt0.
    default: 0
    constraints:
      - range: { min: 0, max: 1 }

  floating_ip_count_pkt1:
    type: number
    label: Number of Floating IPs on pkt1
    description: Number of public IPs on pkt1.
    default: 0
    constraints:
      - range: { min: 0, max: 1 }

#################################################
# Enable/Disable Reverse NAT feature on the ports
#################################################

  reverse_nat_pkt0:
    type: string
    label: Reverse NAT on pkt0
    description: Enable/Disable reverse NAT on pkt0.
    default: False
    constraints:
      - allowed_values: [True,False]

  reverse_nat_pkt1:
    type: string
    label: Reverse NAT on pkt1
    description: Enable/Disable reverse NAT on pkt1.
    default: False
    constraints:
      - allowed_values: [True,False]

############################
# Private Network Settings
############################

  private_network_mgt0:
    type: string
    label: Management Port 0 Private Network Name or ID
    description: Name/ID of private network for mgt0.
    default: PR_MGMT
    constraints:
      - custom_constraint: 'neutron.network'

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #private_network_mgt1:
  #  type: string
  #  label: Management Port 1 Private Network Name or ID
  #  description: Name/ID of private network for mgt1.
  #  constraints:
  #    - custom_constraint: 'neutron.network'

  private_network_ha:
    type: string
    label: HA Port Private Network Name or ID
    description: Name/ID of private network for ha0.
    default: ha
    constraints:
      - custom_constraint: 'neutron.network'

  private_network_pkt0:
    type: string
    label: Packet Port 0 Private Network Name or ID
    description: Name/ID of private network for pkt0.
    default: sriov_pkt0
    constraints:
      - custom_constraint: 'neutron.network'

  private_network_pkt1:
    type: string
    label: Packet Port 1 Private Network Name or ID
    description: Name/ID of private network for pkt1.
    default: sriov_pkt1
    constraints:
      - custom_constraint: 'neutron.network'

############################
# Private Subnet Settings
############################

  private_subnet_mgt0:
    type: string
    label: Management Port 0 Private Subnet Name or ID
    description: Name/ID of private subnet for mgt0.
    default: PR_MGMT

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #private_subnet_mgt1:
  #  type: string
  #  label: Management Port 1 Private Subnet Name or ID
  #  description: Name/ID of private subnet for mgt1.

  private_subnet_ha:
    type: string
    label: HA Port Private Subnet Name or ID
    description: Name/ID of private subnet for ha0.
    default: ha

  private_subnet_pkt0:
    type: string
    label: Packet Port 0 Private Subnet Name or ID
    description: Name/ID of private subnet for pkt0.
    default: sriov_pkt0

  private_subnet_pkt1:
    type: string
    label: Packet Port 1 Private Subnet Name or ID
    description: Name/ID of private subnet for pkt1.
    default: sriov_pkt1

#################
# ACTIVE INSTANCE
#################
##################################
# IP address of the Non-DHCP ports
##################################
  mgt0IPAddressActive:
    type: string
    label: Management Port 0 IP Address (Active Instance)
    description: IP address for mgt0 port on Active instance
    default : 10.34.224.111

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #mgt1IPAddressActive:
  #  type: comma_delimited_list
  #  label: Management Port 1 IP Address (Active Instance)
  #  description: IP address for mgt1 port on Active instance
  #  default : ""

  ha0IPAddressActive:
    type: string
    label: High Availability Port IP Address (Active Instance)
    description: IP address for ha0 port on Active instance
    default : 192.168.2.111

  pkt0IPAddressActive:
    type: string
    label: Packet Port 0 IP Address (Active Instance)
    description: IP address for pkt0 port on Active instance
    default : 10.34.226.111

  pkt1IPAddressActive:
    type: string
    label: Packet Port 1 IP Address (Active Instance)
    description: IP address for pkt1 port on Active instance
    default : 10.34.227.111

##################
# STANDBY INSTANCE
##################
##################################
# IP address of the Non-DHCP ports
##################################
  mgt0IPAddressStandby:
    type: standby
    label: Management Port 0 IP Address (Standby Instance)
    description: IP address for mgt0 port on Standby instance
    default : 10.34.224.112

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #mgt1IPAddressStandby:
  #  type: comma_delimited_list
  #  label: Management Port 1 IP Address (Standby Instance)
  #  description: IP address for mgt1 port on Standby instance
  #  default : ""

  ha0IPAddressStandby:
    type: string
    label: High Availability Port IP Address (Standby Instance)
    description: IP address for ha0 port on Standby instance
    default : 192.168.2.112

  pkt0IPAddressStandby:
    type: string
    label: Packet Port 0 IP Address (Standby Instance)
    description: IP address for pkt0 port on Standby instance
    default : 10.34.226.109

  pkt1IPAddressStandby:
    type: string
    label: Packet Port 1 IP Address (Standby Instance)
    description: IP address for pkt1 port on Standby instance
    default : 10.34.227.112

##########################
# VIRTUAL PORTS IP ADDRESS
##########################
  logicalManagementIpAddress:
    type: comma_delimited_list
    label: Logical IP for Management Port 0
    description: Logical IP Address to be Assigned on Management Port 0
    default : "None"

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #logicalManagementIpAddress_1:
  #  type: comma_delimited_list
  #  label: Logical IP for Management Port 1
  #  description: Logical IP Address to be Assigned on Management Port 1
  #  default : ""

  pkt0VirtualIpAddress:
    type: comma_delimited_list
    label: Virtual IP for Packet Port 0
    description: Virtual IP Address to be Assigned on Packet Port 0 
    default : "None"

  pkt1VirtualIpAddress:
    type: comma_delimited_list
    label: Virtual IP for Packet Port 1
    description: Virtual IP Address to be Assigned on Packet Port 1
    default : "None"

####################################
# Netmask for each Non-DHCP networks
####################################
  mgt0SubnetPrefix:
    type: comma_delimited_list
    label: Management Port 0 Subnet prefix 
    description: Subnet prefix  for mgt0 port
    default : 24

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #mgt1SubnetPrefix:
  #  type: comma_delimited_list
  #  label: Management Port 1 Subnet prefix 
  #  description: Subnet prefix  for mgt1 port
  #  default : ""

  ha0SubnetPrefix:
    type: string
    label: High Availability Port Subnet prefix 
    description: Subnet prefix  for ha0 port 
    default : 24

  pkt0SubnetPrefix:
    type: comma_delimited_list
    label: Packet Port 0 Subnet prefix 
    description: Subnet prefix  for pkt0 port
    default : 24

  pkt1SubnetPrefix:
    type: comma_delimited_list
    label: Packet Port 1 Subnet prefix 
    description: Subnet prefix  for pkt1 port
    default : 24

###############################
# Non DHCP Network's gateway IP
###############################

  mgt0Gateway:
    type: comma_delimited_list
    label: Management Port 0 Gateway IP
    description: Gateway IP Address for mgt0 port
    default : 10.34.224.1

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #mgt1Gateway:
  #  type: comma_delimited_list
  #  label: Management Port 1 Gateway IP
  #  description: Gateway IP Address for mgt1 port
  #  default : ""

  ha0Gateway:
    type: string
    label: High Availability Port Gateway IP
    description: Gateway IP Address for ha0 port
    default : 192.168.2.1

  pkt0Gateway:
    type: comma_delimited_list
    label: Packet Port 0 Gateway IP
    description: Gateway IP Address for pkt0 port
    default : 10.34.226.1

  pkt1Gateway:
    type: comma_delimited_list
    label: Packet Port 1 Gateway IP
    description: Gateway IP Address for pkt1 port 
    default : 10.34.227.1

###########################################################
# VLAN ID PKT interfaces
# Keeping it a string value instead of integer, as we need 
# to support None value
###########################################################

  vlanIdPkt0:
    type: string
    label: Packet Port 0 VLAN ID
    description: Packet Port 0 VLAN ID
    default : 626

  vlanIdPkt1:
    type: string
    label: Packet Port 1 VLAN ID
    description: Packet Port 1 VLAN ID
    default : 627

############################
# Instance Specific Settings
############################
  sbc_active_name:
    type: string
    label: SBC (Assigned) Active Instance Name
    description: SBC active instance name.
    default: "ISBC_active"
    constraints:
      - length: { min: 0, max: 63 }
        description: "Enter valid active instance name. Length of this string should be less than 63"
      - allowed_pattern: "^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$"
        description: "Enter valid active instance name. Regex: ^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$ "

  sbc_standby_name:
    type: string
    label: SBC (Assigned) Standby Instance Name
    description: SBC standby instance name.
    default: "ISBC_standby"
    constraints:
      - length: { min: 0, max: 63 }
        description: "Enter valid standby instance name. Length of this string should be less than 63"
      - allowed_pattern: "^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$"
        description: "Enter valid standby instance name. Regex: ^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$ "

  sbc_ceMode:
    type: string
    label: SBC Configured CE Mode
    description: SBC Configured CE Mode.
    default: "sbc"
    constraints:
      - length: { min: 0, max: 8 }
        description: "Enter valid instance mode. Role can be sbc"
      - allowed_pattern: "^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$"
        description: "Enter valid instance role. Regex: ^[A-Za-z]{1}[-A-Za-z0-9.]*[A-Za-z0-9]{1}$ "
      - allowed_values: [sbc]

###################
# Alternate IP list
###################

  # pkt0_vips:
    # type: comma_delimited_list
    # label: comma separated list of alternate IPs for pkt0
    # description: comma separated list of alternate IPs for pkt0
    # default: ""

  # pkt1_vips:
    # type: comma_delimited_list
    # label: comma separated list of alternate IPs for pkt1
    # description: comma separated list of alternate IPs for pkt1
    # default: ""

  # additional_Fips_pkt0:
    # type: comma_delimited_list
    # label: comma separated list of additional floating IPs for pkt0
    # description: comma separated list of additional floating IPs for pkt0
    # default: ""

  # additional_Fips_pkt1:
    # type: comma_delimited_list
    # label: comma separated list of additional floating IPs for pkt1
    # description: comma separated list of additional floating IPs for pkt1
    # default: ""


################
# EMS Settings
################
  ems_user_name:
    type: string
    label: EMS User Name
    description: User name for registering with EMS
    default: "None"

  ems_password:
    type: string
    label: EMS Password
    description: EMS registration password
    hidden: true
    default: "None"

  ems_ip:
    type: string
    label: EMS IP
    description: EMS IP Address(es)- e.g. single IP - "1.2.3.4" (include double quotes), multiple IPs - ["1.2.3.4", "5.6.7.8"]
    default: "None"

  cluster_id:
    type: string
    label: Cluster ID
    description: EMS cluster identifier.
    default: "None"

  download_config:
    type: string
    label: Download Configuration from EMS
    description: Download Configuration from EMS
    default: False
    constraints:
      - allowed_values: [True,False]

###############################
# DHCP flags
###############################

  isDhcpEnabledOnMgt0:
    type: string
    label: Is DHCP enabled on Mgt0 Subnet?
    description: Is DHCP enabled on Mgt0 Subnet?
    default : False
    constraints:
      - allowed_values: [True,False]

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #isDhcpEnabledOnMgt1:
  #  type: string
  #  label: Is DHCP enabled on Mgt1 Subnet?
  #  description: Is DHCP enabled on Mgt1 Subnet?
  #  default : False
  #  constraints:
  #    - allowed_values: [True,False]

  isDhcpEnabledOnHa0:
    type: string
    label: Is DHCP enabled on Ha0 Subnet?
    description: Is DHCP enabled on Ha0 Subnet?
    default : False
    constraints:
      - allowed_values: [True,False]

  isDhcpEnabledOnPkt0:
    type: string
    label: Is DHCP enabled on Pkt0 Subnet?
    description: Is DHCP enabled on Pkt0 Subnet?
    default : False
    constraints:
      - allowed_values: [True,False]

  isDhcpEnabledOnPkt1:
    type: string
    label: Is DHCP enabled on Pkt1 Subnet?
    description: Is DHCP enabled on Pkt1 Subnet?
    default : False
    constraints:
      - allowed_values: [True,False]

###############################
# SBC login credentials
###############################

  adminSshKey:
    type: string
    label: adminSshKey
    description: public key to login to SBC CLI as admin user

  linuxAdminSshKey:
    type: string
    label: linuxAdminSshKey
    description: public key to login to SBC shell as linuxadmin user

  adminPassword:
    type: string
    label: adminPasswordHash
    description: password hash to login to SBC CLI as admin user
    default : "*"

  linuxAdminPassword:
    type: string
    label: linuxAdminPasswordHash
    description: password hash to login to SBC shell as linuxadmin user
    default : "*"

# Resource definitions for all openstack objects to be configured during
# template execution
resources:

  # Create standby vSBC instance
  vSBC_STANDBY:
    type: OS::Nova::Server
    properties:
      name: { list_join: ['-', [ { get_param: "OS::stack_name" }, '2']] }
      image: { get_param: image }
      flavor: { get_param: flavor }
      config_drive: True
      #personality: 
        #"baseConfig.cli": {get_file: "RIBBON_BASE_CONFIG.cli"}
        #"baseConfig.cli": {get_file: "http://10.11.12.13/sbcCliFiles/RIBBON_BASE_CONFIG.cli"}

      # Attach previously created network ports to the instnace
      networks:
        - port: { get_resource: mgt0_port2 }
        - port: { get_resource: ha0_port2 }
        - port: { get_resource: pkt0_port2 }
        - port: { get_resource: pkt1_port2 }
        # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
        #- port: { get_resource: mgt1_port2 }

      # Publish the assigned floating IP addresses with appended subnet mask to the openstack metadata service.
      # Subnet prefix for floating ips not used - hard coded to 32 for consistencey.
      metadata:

        IF0: { "Port":"Mgt0",
               "DHCP":  { get_param: isDhcpEnabledOnMgt0},
               "GWV4":  { get_param: [ mgt0Gateway, 0] },
               "IPV4":  { list_join: ['/', [ { get_param: [ mgt0IPAddressStandby, 0] }, { get_param: [ mgt0SubnetPrefix, 0] }]] },
               "GWV6":  { get_param: [ mgt0Gateway, 1] },
               "IPV6":  { list_join: ['/', [ { get_param: [ mgt0IPAddressStandby, 1] }, { get_param: [ mgt0SubnetPrefix, 1] }]] },
             }

        IF1: { "Port":"Ha0", 
               "DHCP": { get_param: isDhcpEnabledOnHa0},
               "GWV4": { get_param: ha0Gateway },
               "IPV4": { list_join: ['/', [ { get_attr: [ha0_port2, fixed_ips, 0, ip_address] }, { get_param: ha0SubnetPrefix}]] }
             }

        IF2: { "Port":"Pkt0", 
               "DHCP": { get_param: isDhcpEnabledOnPkt0},
               "GWV4": { get_param: [ pkt0Gateway, 0] },
               "IPV4": { list_join: ['/', [ { get_param: [ pkt0VirtualIpAddress, 0] }, { get_param: [ pkt0SubnetPrefix, 0] }]] },
               "GWV6": { get_param: [ pkt0Gateway, 1] },
               "IPV6": { list_join: ['/', [ { get_param: [ pkt0VirtualIpAddress, 1] }, { get_param: [ pkt0SubnetPrefix, 1] }]] },
               "RNat": { get_param: reverse_nat_pkt0 },
               "VlanId": { get_param: vlanIdPkt0 }
             }

        IF3: { "Port":"Pkt1", 
               "DHCP": { get_param: isDhcpEnabledOnPkt1},
               "GWV4": { get_param: [ pkt1Gateway, 0] },
               "IPV4": { list_join: ['/', [ { get_param: [ pkt1VirtualIpAddress, 0] }, { get_param: [ pkt1SubnetPrefix, 0] }]] },
               "GWV6": { get_param: [ pkt1Gateway, 1] },
               "IPV6": { list_join: ['/', [ { get_param: [ pkt1VirtualIpAddress, 1] }, { get_param: [ pkt1SubnetPrefix, 1] }]] },
               "RNat": { get_param: reverse_nat_pkt1 },
               "VlanId": { get_param: vlanIdPkt1 }
             }

        LOGICAL_MGMT_IP: { "IFName": "IF0", 
                           "IPV4": { get_param: [logicalManagementIpAddress, 0] }, 
                           "IPV6": { get_param: [logicalManagementIpAddress, 1] } 
                         }

        ClusterIp: { get_attr: [ha0_port1, fixed_ips, 0, ip_address]}

      #  ALT_PKT0_01: { "IFName": "IF2", "IP": {get_param: [pkt0_vips,0]} }
      #  ALT_PKT0_02: { "IFName": "IF2", "IP": {get_param: [pkt0_vips,1]} }
      #  ALT_PKT1_01: { "IFName": "IF3", "IP": {get_param: [pkt1_vips,0]} }
      #  ALT_PKT1_02: { "IFName": "IF3", "IP": {get_param: [pkt1_vips,1]} }

      # METADATA_APPEND_ABOVE
      # Make sure that the indentation is maintained same as the existing
      # metadata elements.

      # Set the format to RAW to pass data directly as userdata set the floating and virtual IP counts
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
                #cloud-config
                ### USER EDITABLE SECTION FOR SSH KEYS ###
                users:
                    - name: admin
                      ssh-authorized-keys:
                        - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA4oGIi+0mRS9Q25ln5/gKe1mmR7cfVuFxRQONVbjq8y+JB0g2T49b1Bf8xRhyhkKgdbIbEWdcmboSpTegt6zM0rz6Yw/73c3NVy60CX47t55GCCFYXxt3uwgRlN/9KX1mETCYOSD5AZ7e9YXvbd6/hUKkK/o8Zrhch9ckR2nVSe0v1wob4MMhmC1e9LV5tvk6zAIdmTWOYcrg0Yd6yHRQbNjlVFpQ147TPGy12+tDytqEW+09DQZqvhuiwSyxk3lBlNJYfCT2VidsS2+MQYD+t2REc65vcq/EvXuyuwpvv/IIjX2BBMCG7fMXkGh0wnIPoHbUCNfq1Zr2JGqZ6D8GIQ==
                      plain_text_passwd: admin
                      lock_passwd: false
                    - name: linuxadmin
                      ssh-authorized-keys:
                        - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA4oGIi+0mRS9Q25ln5/gKe1mmR7cfVuFxRQONVbjq8y+JB0g2T49b1Bf8xRhyhkKgdbIbEWdcmboSpTegt6zM0rz6Yw/73c3NVy60CX47t55GCCFYXxt3uwgRlN/9KX1mETCYOSD5AZ7e9YXvbd6/hUKkK/o8Zrhch9ckR2nVSe0v1wob4MMhmC1e9LV5tvk6zAIdmTWOYcrg0Yd6yHRQbNjlVFpQ147TPGy12+tDytqEW+09DQZqvhuiwSyxk3lBlNJYfCT2VidsS2+MQYD+t2REc65vcq/EvXuyuwpvv/IIjX2BBMCG7fMXkGh0wnIPoHbUCNfq1Zr2JGqZ6D8GIQ==
                      plain_text_passwd: sonus
                      lock_passwd: false
                    - name: root
                      ssh-authorized-keys:
                        - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA4oGIi+0mRS9Q25ln5/gKe1mmR7cfVuFxRQONVbjq8y+JB0g2T49b1Bf8xRhyhkKgdbIbEWdcmboSpTegt6zM0rz6Yw/73c3NVy60CX47t55GCCFYXxt3uwgRlN/9KX1mETCYOSD5AZ7e9YXvbd6/hUKkK/o8Zrhch9ckR2nVSe0v1wob4MMhmC1e9LV5tvk6zAIdmTWOYcrg0Yd6yHRQbNjlVFpQ147TPGy12+tDytqEW+09DQZqvhuiwSyxk3lBlNJYfCT2VidsS2+MQYD+t2REc65vcq/EvXuyuwpvv/IIjX2BBMCG7fMXkGh0wnIPoHbUCNfq1Zr2JGqZ6D8GIQ==
                      plain_text_passwd: sonus1                    
                      lock_passwd: false
                runcmd:
                    - [ usermod, -p, '$6$io3njQos$gZtBJ4MazQeWC0beqQwRPUDZCQcKXhMr2B8QLWYGajchR2BtkyHPvBTCQj0LctHAFaYTwbsIsUkm12ta4IoLe/', linuxadmin ]
                    - sed -i -e "/^AllowUsers/s/\slinuxadmin\(\s\|$\)/ /g" -e "/^AllowUsers/s/\sroot\(\s\|$\)/ /g" /etc/ssh/sshd_config
                    - sed -i "/^AllowUsers/s/AllowUsers /AllowUsers root linuxadmin /" /etc/ssh/sshd_config
                    - sed -i "/PasswordAuthentication no/s/PasswordAuthentication no/PasswordAuthentication yes/" /etc/ssh/sshd_config
                    - sed -i "/^PermitRootLogin/s/ no/ yes/" /etc/ssh/sshd_config
                    - sed -i "s/allowSshAccess=n/allowSshAccess=y/" /opt/sonus/conf/sbx.conf
                write_files:
                -   content: |
                        {
                          "CERole"                  : "STANDBY",
                          "CEName"                  : "$ce_name",
                          "CEMode"                  : "$ce_mode",
                          "SystemName"              : "$system_name",
                          "SbcPersonalityType"      : "$personality",
                          "SbcHaMode"               : "$ha_mode",
                          "PeerCEName"              : "$peer_name",
                          "PeerCEHa0IPv4Prefix"     : "$peer_prefix_ha0",
                          "PeerCEHa0IPv4Address"    : "$peer_ipv4_ha0",
                          "PeerCEMgt0IPv4Prefix"    : "$peer_ipv4_prefix_mgt0",
                          "PeerCEMgt0IPv4Address"   : "$peer_ipv4_mgt0",
                          "PeerCEMgt0IPv6Prefix"    : "$peer_ipv6_prefix_mgt0",
                          "PeerCEMgt0IPv6Address"   : "$peer_ipv6_mgt0",
                          "EmsUsername"             : "$ems_user_name",
                          "EmsPassword"             : "$ems_password",
                          "EmsIP"                   : "$ems_ip",
                          "EmsDownloadConfig"       : "$downloadConfig",
                          "EmsPrivateNodeParameters": { "cluster_id": "$cluster_id" , "vnfc_id": "$vnfc_id" }
                        }
                    path: /opt/sonus/conf/userData.json
                    
          params:
              $ce_name:               { get_param: sbc_standby_name }
              $ce_mode:               { get_param: sbc_ceMode } 
              $system_name:           { get_param: sbc_system_name }
              $personality:           { get_param: personality }
              $ha_mode:               { get_param: ha_mode }
              $peer_name:             { get_param: sbc_active_name }
              $peer_ipv4_ha0:         { get_attr: [ha0_port1, fixed_ips, 0, ip_address] }
              $peer_prefix_ha0:       { get_param: ha0SubnetPrefix }
              $peer_ipv4_mgt0:        { get_param: [ mgt0IPAddressActive, 0] }
              $peer_ipv4_prefix_mgt0: { get_param: [ mgt0SubnetPrefix, 0] }
              $peer_ipv6_mgt0:        { get_param: [ mgt0IPAddressActive, 1] }
              $peer_ipv6_prefix_mgt0: { get_param: [ mgt0SubnetPrefix, 1] }
              $ems_user_name:         { get_param: ems_user_name }
              $ems_password:          { get_param: ems_password }
              $ems_ip:                { get_param: ems_ip }
              $cluster_id:            { get_param: cluster_id }
              $downloadConfig:        { get_param: download_config }
              $vnfc_id:               { list_join: ['-', [ { get_param: "OS::stack_name" }, { get_param: cluster_id }, '2']] }
              $adminSshKey:           { get_param: adminSshKey }
              $linuxAdminSshKey:      { get_param: linuxAdminSshKey }
              $adminPassword:         { get_param: adminPassword }
              $linuxAdminPassword:    { get_param: linuxAdminPassword }

  # Create active vSBC instance
  vSBC_ACTIVE:
    type: OS::Nova::Server
    properties:
      name: { list_join: ['-', [ { get_param: "OS::stack_name" }, '1']] }
      image: { get_param: image }
      flavor: { get_param: flavor }
      config_drive: True
      #personality: 
        #"baseConfig.cli": {get_file: "RIBBON_BASE_CONFIG.cli"}
        #"baseConfig.cli": {get_file: "http://10.11.12.13/sbcCliFiles/RIBBON_BASE_CONFIG.cli"}

      # Attach previously created network ports to the instance
      networks:
        - port: { get_resource: mgt0_port1 }
        - port: { get_resource: ha0_port1 }
        - port: { get_resource: pkt0_port1 }
        - port: { get_resource: pkt1_port1 }
        # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
        #- port: { get_resource: mgt1_port1 }

      # Publish the assigned floating IP addresses with appended subnet mask to the openstack metadata service.
      # Subnet prefix for floating ips not used - hard coded to 32 for consistencey.
      metadata:

        IF0: { "Port":"Mgt0",
               "DHCP":  { get_param: isDhcpEnabledOnMgt0},
               "GWV4":  { get_param: [ mgt0Gateway, 0] },
               "IPV4":  { list_join: ['/', [ { get_param: [ mgt0IPAddressActive, 0] }, { get_param: [ mgt0SubnetPrefix, 0] }]] },
               "GWV6":  { get_param: [ mgt0Gateway, 1] },
               "IPV6":  { list_join: ['/', [ { get_param: [ mgt0IPAddressActive, 1] }, { get_param: [ mgt0SubnetPrefix, 1] }]] },
             }

        IF1: { "Port":"Ha0",
               "DHCP": { get_param: isDhcpEnabledOnHa0},
               "GWV4": { get_param: ha0Gateway },
               "IPV4": { list_join: ['/', [ { get_attr: [ha0_port1, fixed_ips, 0, ip_address] }, { get_param: ha0SubnetPrefix}]] }
             }

        IF2: { "Port":"Pkt0",
               "DHCP": { get_param: isDhcpEnabledOnPkt0},
               "GWV4": { get_param: [ pkt0Gateway, 0] },
               "IPV4": { list_join: ['/', [ { get_param: [ pkt0VirtualIpAddress, 0] }, { get_param: [ pkt0SubnetPrefix, 0] }]] },
               "GWV6": { get_param: [ pkt0Gateway, 1] },
               "IPV6": { list_join: ['/', [ { get_param: [ pkt0VirtualIpAddress, 1] }, { get_param: [ pkt0SubnetPrefix, 1] }]] },
               "RNat": { get_param: reverse_nat_pkt0 },
               "VlanId": { get_param: vlanIdPkt0 }
             }

        IF3: { "Port":"Pkt1",
               "DHCP": { get_param: isDhcpEnabledOnPkt1},
               "GWV4": { get_param: [ pkt1Gateway, 0] },
               "IPV4": { list_join: ['/', [ { get_param: [ pkt1VirtualIpAddress, 0] }, { get_param: [ pkt1SubnetPrefix, 0] }]] },
               "GWV6": { get_param: [ pkt1Gateway, 1] },
               "IPV6": { list_join: ['/', [ { get_param: [ pkt1VirtualIpAddress, 1] }, { get_param: [ pkt1SubnetPrefix, 1] }]] },
               "RNat": { get_param: reverse_nat_pkt1 },
               "VlanId": { get_param: vlanIdPkt1 }
             }

        LOGICAL_MGMT_IP: { "IFName": "IF0",
                           "IPV4": { get_param: [logicalManagementIpAddress, 0] },
                           "IPV6": { get_param: [logicalManagementIpAddress, 1] }
                         }

        ClusterIp: { get_attr: [ha0_port2, fixed_ips, 0, ip_address]}

      #  ALT_PKT0_01: { "IFName": "IF2", "IP": {get_param: [pkt0_vips,0]} }
      #  ALT_PKT0_02: { "IFName": "IF2", "IP": {get_param: [pkt0_vips,1]} }
      #  ALT_PKT1_01: { "IFName": "IF3", "IP": {get_param: [pkt1_vips,0]} }
      #  ALT_PKT1_02: { "IFName": "IF3", "IP": {get_param: [pkt1_vips,1]} }

      # METADATA_APPEND_ABOVE
      # Make sure that the indentation is maintained same as the existing
      # metadata elements.


      # Set the format to RAW to pass data directly as userdata set the floating and virtual IP counts
      user_data_format: RAW
      user_data:
        str_replace:
          template: |
                #cloud-config
                ### USER EDITABLE SECTION FOR SSH KEYS ###
                users:
                    - name: admin
                      ssh-authorized-keys:
                        - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA4oGIi+0mRS9Q25ln5/gKe1mmR7cfVuFxRQONVbjq8y+JB0g2T49b1Bf8xRhyhkKgdbIbEWdcmboSpTegt6zM0rz6Yw/73c3NVy60CX47t55GCCFYXxt3uwgRlN/9KX1mETCYOSD5AZ7e9YXvbd6/hUKkK/o8Zrhch9ckR2nVSe0v1wob4MMhmC1e9LV5tvk6zAIdmTWOYcrg0Yd6yHRQbNjlVFpQ147TPGy12+tDytqEW+09DQZqvhuiwSyxk3lBlNJYfCT2VidsS2+MQYD+t2REc65vcq/EvXuyuwpvv/IIjX2BBMCG7fMXkGh0wnIPoHbUCNfq1Zr2JGqZ6D8GIQ==
                      plain_text_passwd: admin
                      lock_passwd: false
                    - name: linuxadmin
                      ssh-authorized-keys:
                        - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA4oGIi+0mRS9Q25ln5/gKe1mmR7cfVuFxRQONVbjq8y+JB0g2T49b1Bf8xRhyhkKgdbIbEWdcmboSpTegt6zM0rz6Yw/73c3NVy60CX47t55GCCFYXxt3uwgRlN/9KX1mETCYOSD5AZ7e9YXvbd6/hUKkK/o8Zrhch9ckR2nVSe0v1wob4MMhmC1e9LV5tvk6zAIdmTWOYcrg0Yd6yHRQbNjlVFpQ147TPGy12+tDytqEW+09DQZqvhuiwSyxk3lBlNJYfCT2VidsS2+MQYD+t2REc65vcq/EvXuyuwpvv/IIjX2BBMCG7fMXkGh0wnIPoHbUCNfq1Zr2JGqZ6D8GIQ==
                      plain_text_passwd: sonus
                      lock_passwd: false
                    - name: root
                      ssh-authorized-keys:
                        - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEA4oGIi+0mRS9Q25ln5/gKe1mmR7cfVuFxRQONVbjq8y+JB0g2T49b1Bf8xRhyhkKgdbIbEWdcmboSpTegt6zM0rz6Yw/73c3NVy60CX47t55GCCFYXxt3uwgRlN/9KX1mETCYOSD5AZ7e9YXvbd6/hUKkK/o8Zrhch9ckR2nVSe0v1wob4MMhmC1e9LV5tvk6zAIdmTWOYcrg0Yd6yHRQbNjlVFpQ147TPGy12+tDytqEW+09DQZqvhuiwSyxk3lBlNJYfCT2VidsS2+MQYD+t2REc65vcq/EvXuyuwpvv/IIjX2BBMCG7fMXkGh0wnIPoHbUCNfq1Zr2JGqZ6D8GIQ==
                      plain_text_passwd: sonus1                    
                      lock_passwd: false
                runcmd:
                    - [ usermod, -p, '$6$io3njQos$gZtBJ4MazQeWC0beqQwRPUDZCQcKXhMr2B8QLWYGajchR2BtkyHPvBTCQj0LctHAFaYTwbsIsUkm12ta4IoLe/', linuxadmin ]
                    - sed -i -e "/^AllowUsers/s/\slinuxadmin\(\s\|$\)/ /g" -e "/^AllowUsers/s/\sroot\(\s\|$\)/ /g" /etc/ssh/sshd_config
                    - sed -i "/^AllowUsers/s/AllowUsers /AllowUsers root linuxadmin /" /etc/ssh/sshd_config
                    - sed -i "/PasswordAuthentication no/s/PasswordAuthentication no/PasswordAuthentication yes/" /etc/ssh/sshd_config
                    - sed -i "/^PermitRootLogin/s/ no/ yes/" /etc/ssh/sshd_config
                    - sed -i "s/allowSshAccess=n/allowSshAccess=y/" /opt/sonus/conf/sbx.conf
                write_files:
                -   content: |
                        {
                          "CERole"                  : "ACTIVE",
                          "CEName"                  : "$ce_name",
                          "CEMode"                  : "$ce_mode",
                          "SystemName"              : "$system_name",
                          "SbcPersonalityType"      : "$personality",
                          "SbcHaMode"               : "$ha_mode",
                          "PeerCEName"              : "$peer_name",
                          "PeerCEHa0IPv4Prefix"     : "$peer_prefix_ha0",
                          "PeerCEHa0IPv4Address"    : "$peer_ipv4_ha0",
                          "PeerCEMgt0IPv4Prefix"    : "$peer_ipv4_prefix_mgt0",
                          "PeerCEMgt0IPv4Address"   : "$peer_ipv4_mgt0",
                          "PeerCEMgt0IPv6Prefix"    : "$peer_ipv6_prefix_mgt0",
                          "PeerCEMgt0IPv6Address"   : "$peer_ipv6_mgt0",
                          "EmsUsername"             : "$ems_user_name",
                          "EmsPassword"             : "$ems_password",
                          "EmsIP"                   : "$ems_ip",
                          "EmsDownloadConfig"       : "$downloadConfig",
                          "EmsIP"                   : "$ems_ip",
                          "EmsPrivateNodeParameters": { "cluster_id": "$cluster_id" , "vnfc_id": "$vnfc_id" }
                        }
                    path: /opt/sonus/conf/userData.json
                
          params:
              $ce_name:               { get_param: sbc_active_name  }
              $ce_mode:               { get_param: sbc_ceMode }
              $system_name:           { get_param: sbc_system_name }
              $personality:           { get_param: personality }
              $ha_mode:               { get_param: ha_mode }
              $peer_name:             { get_param: sbc_standby_name }
              $peer_ipv4_ha0:         { get_attr: [ha0_port2, fixed_ips, 0, ip_address] }
              $peer_prefix_ha0:       { get_param: ha0SubnetPrefix }
              $peer_ipv4_mgt0:        { get_param: [ mgt0IPAddressStandby, 0] }
              $peer_ipv4_prefix_mgt0: { get_param: [ mgt0SubnetPrefix, 0] }
              $peer_ipv6_mgt0:        { get_param: [ mgt0IPAddressStandby, 1] }
              $peer_ipv6_prefix_mgt0: { get_param: [ mgt0SubnetPrefix, 1] }
              $ems_user_name:         { get_param: ems_user_name }
              $ems_password:          { get_param: ems_password }
              $ems_ip:                { get_param: ems_ip }
              $cluster_id:            { get_param: cluster_id }
              $downloadConfig:        { get_param: download_config }
              $vnfc_id:               { list_join: ['-', [ { get_param: "OS::stack_name" }, { get_param: cluster_id }, '1']] }
              $adminSshKey:           { get_param: adminSshKey }
              $linuxAdminSshKey:      { get_param: linuxAdminSshKey }
              $adminPassword:         { get_param: adminPassword }
              $linuxAdminPassword:    { get_param: linuxAdminPassword }


  # VIP PORT CREATION
  mgt0_vip_port:
    type: OS::Neutron::Port
    properties:
      network: { get_param : private_network_mgt0 }
      fixed_ips:
        # mgt0 EDIT: uncomment below line to DISABLE DHCP or comment to ENABLE DHCP
        - ip_address: { get_param: [logicalManagementIpAddress, 0] }
        - ip_address: { get_param: [logicalManagementIpAddress, 1] }
       
        # mgt0 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
        #- subnet: { get_param: private_subnet_mgt0 }

      # mgt0 EDIT: uncomment below line to ENABLE SR-IOV support or comment to
      # disable it
      #binding:vnic_type: direct
      security_groups:
        - { get_param: security_group }

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #mgt1_vip_port:
  #  type: OS::Neutron::Port
  #  properties:
  #    network: { get_param : private_network_mgt1 }
  #    fixed_ips:
  #      # mgt1 EDIT: uncomment below line to DISABLE DHCP or comment to ENABLE DHCP
  #      - ip_address: { get_param: [logicalManagementIpAddress_1, 0] }
  #      - ip_address: { get_param: [logicalManagementIpAddress_1, 1] }
  #     
  #      # mgt1 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
  #      #- subnet: { get_param: private_subnet_mgt1 }
  #
  #    # mgt1 EDIT: uncomment below line to ENABLE SR-IOV support or comment to
  #    # disable it
  #    #binding:vnic_type: direct
  #    security_groups:
  #      - { get_param: security_group }

  # EDIT - VIP PORT CREATION
  pkt0_vip_port:
    type: OS::Neutron::Port
    properties:
      network: { get_param : private_network_pkt0 }
      fixed_ips:
        # pkt0 EDIT: uncomment below line to DISABLE DHCP or comment to ENABLE DHCP
        - ip_address: { get_param: [pkt0VirtualIpAddress, 0]}
        - ip_address: { get_param: [pkt0VirtualIpAddress, 1]}
        #- ip_address: {get_param: [pkt0_vips,0]}
        #- ip_address: {get_param: [pkt0_vips,1]}

        # pkt0 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
        #- subnet: { get_param: private_subnet_pkt0}

      # pkt0 EDIT: uncomment below line to ENABLE SR-IOV support or comment to
      # disable it
      #binding:vnic_type: direct
      security_groups:
        - { get_param: security_group }

  # EDIT - VIP PORT CREATION
  pkt1_vip_port:
    type: OS::Neutron::Port
    properties:
      network: { get_param : private_network_pkt1 }
      fixed_ips:
        # pkt1 EDIT: uncomment below line to DISABLE DHCP or comment to ENABLE DHCP
        - ip_address: { get_param: [pkt1VirtualIpAddress, 0]}
        - ip_address: { get_param: [pkt1VirtualIpAddress, 1]}
        #- ip_address: {get_param: [pkt1_vips,0]}
        #- ip_address: {get_param: [pkt1_vips,1]}

        # pkt1 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
        #- subnet: { get_param: private_subnet_pkt1}

      # pkt1 EDIT: uncomment below line to ENABLE SR-IOV support or comment to
      # disable it
      #binding:vnic_type: direct
      security_groups:
        - { get_param: security_group }


  # PRIVATE PORT CREATION - ACTIVE
  # Create the four required virtual nics (ports) to attach to virtual SBC instance 1
  mgt0_port1:
    type: OS::Neutron::Port
    properties:
      allowed_address_pairs:
        - ip_address: { get_param: [logicalManagementIpAddress, 0] }
        - ip_address: { get_param: [logicalManagementIpAddress, 1] }
      network: { get_param : private_network_mgt0 }
      fixed_ips:
        # mgt0 EDIT: uncomment below line to DISABLE DHCP or comment to ENABLE DHCP
        - ip_address: { get_param: [mgt0IPAddressActive, 0]}
        - ip_address: { get_param: [mgt0IPAddressActive, 1]}

        # mgt0 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
        #- subnet: { get_param: private_subnet_mgt0 }

      # mgt0 EDIT: uncomment below line to ENABLE SR-IOV support or comment to
      # disable it
      #binding:vnic_type: direct
      security_groups:
        - { get_param: security_group }

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #mgt1_port1:
  #  type: OS::Neutron::Port
  #  properties:
  #    allowed_address_pairs:
  #      - ip_address: { get_param: [logicalManagementIpAddress_1, 0] }
  #      - ip_address: { get_param: [logicalManagementIpAddress_1, 1] }
  #    network: { get_param : private_network_mgt1 }
  #    fixed_ips:
  #      # mgt1 EDIT: uncomment below line to DISABLE DHCP or comment to ENABLE DHCP
  #      - ip_address: { get_param: [mgt1IPAddressActive, 0]}
  #      - ip_address: { get_param: [mgt1IPAddressActive, 1]}
  #
  #      # mgt1 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
  #      #- subnet: { get_param: private_subnet_mgt1 }
  #
  #    # mgt1 EDIT: uncomment below line to ENABLE SR-IOV support or comment to
  #    # disable it
  #    #binding:vnic_type: direct
  #    security_groups:
  #      - { get_param: security_group }

  ha0_port1:
    type: OS::Neutron::Port
    properties:
      network: { get_param : private_network_ha }
      fixed_ips:
        # ha0 EDIT: uncomment below line to DISABLE DHCP or comment to ENABLE DHCP
        - ip_address: { get_param: ha0IPAddressActive}

        # ha0 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
        #- subnet: { get_param: private_subnet_ha }

      # ha0 EDIT: uncomment below line to ENABLE SR-IOV support or comment to
      # disable it
      #binding:vnic_type: direct

  # EDIT - PRIVATE PORT CREATION - ACTIVE
  pkt0_port1:
    type: OS::Neutron::Port
    properties:
      allowed_address_pairs: 
        - ip_address: { get_param: [pkt0VirtualIpAddress, 0]}
        - ip_address: { get_param: [pkt0VirtualIpAddress, 1]}
        #- ip_address: {get_param: [pkt0_vips,0]}
        #- ip_address: {get_param: [pkt0_vips,1]} 

      network: { get_param : private_network_pkt0 }
      fixed_ips:
        #pkt0 EDIT: uncomment below line to DISABLE DHCP or comment to ENABLE DHCP
        - ip_address: { get_param: [pkt0IPAddressActive, 0]}
        - ip_address: { get_param: [pkt0IPAddressActive, 1]}

        # pkt0 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
        #- subnet: { get_param: private_subnet_pkt0}

      # pkt0 EDIT: uncomment below line to ENABLE SR-IOV support or comment to
      # disable it
      #binding:vnic_type: direct
      security_groups:
        - { get_param: security_group }

  # EDIT - PRIVATE PORT CREATION - ACTIVE
  pkt1_port1:
    type: OS::Neutron::Port
    properties:
      allowed_address_pairs: 
        - ip_address: { get_param: [pkt1VirtualIpAddress, 0]}
        - ip_address: { get_param: [pkt1VirtualIpAddress, 1]}
        #- ip_address: {get_param: [pkt1_vips,0]}
        #- ip_address: {get_param: [pkt1_vips,1]}
      network: { get_param : private_network_pkt1 }
      fixed_ips:
        # pkt1 EDIT: uncomment below line to DISABLE DHCP or comment to ENABLE DHCP
        - ip_address: { get_param: [pkt1IPAddressActive, 0]}
        - ip_address: { get_param: [pkt1IPAddressActive, 1]}

        # pkt1 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
        #- subnet: { get_param: private_subnet_pkt1}

      # pkt1 EDIT: uncomment below line to ENABLE SR-IOV support or comment to
      # disable it
      #binding:vnic_type: direct
      security_groups:
        - { get_param: security_group }


  # PRIVATE PORT CREATION - STANDBY
  # Create the four required virtual nics (ports) to attach to virtual SBC instance 2
  mgt0_port2:
    type: OS::Neutron::Port
    properties:
      allowed_address_pairs: 
        - ip_address: { get_param: [logicalManagementIpAddress, 0] }
        - ip_address: { get_param: [logicalManagementIpAddress, 1] }
      network: { get_param : private_network_mgt0 }
      fixed_ips:
        # mgt0 EDIT: uncomment below line to DISABLE DHCP or comment to ENABLE DHCP
        - ip_address: { get_param: [mgt0IPAddressStandby, 0]}
        - ip_address: { get_param: [mgt0IPAddressStandby, 1]}

        # mgt0 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
        #- subnet: { get_param: private_subnet_mgt0 }

      # mgt0 EDIT: uncomment below line to ENABLE SR-IOV support or comment to
      # disable it
      #binding:vnic_type: direct
      security_groups:
        - { get_param: security_group }
  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #mgt1_port2:
  #  type: OS::Neutron::Port
  #  properties:
  #    allowed_address_pairs: 
  #      - ip_address: { get_param: [logicalManagementIpAddress_1, 0] }
  #      - ip_address: { get_param: [logicalManagementIpAddress_1, 1] }
  #    network: { get_param : private_network_mgt1 }
  #    fixed_ips:
  #      # mgt1 EDIT: uncomment below line to DISABLE DHCP or comment to ENABLE DHCP
  #      - ip_address: { get_param: [mgt1IPAddressStandby, 0]}
  #      - ip_address: { get_param: [mgt1IPAddressStandby, 1]}
  #
  #      # mgt1 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
  #      #- subnet: { get_param: private_subnet_mgt1 }
  #
  #    # mgt1 EDIT: uncomment below line to ENABLE SR-IOV support or comment to
  #    # disable it
  #    #binding:vnic_type: direct
  #    security_groups:
  #      - { get_param: security_group }

  ha0_port2:
    type: OS::Neutron::Port
    properties:
      network: { get_param : private_network_ha }
      fixed_ips:
        # ha0 EDIT: uncomment below line to DISABLE DHCP or comment to ENABLE DHCP
        - ip_address: { get_param: ha0IPAddressStandby}

        # ha0 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
        #- subnet: { get_param: private_subnet_ha }

      # ha0 EDIT: uncomment below line to ENABLE SR-IOV support or comment to
      # disable it
      #binding:vnic_type: direct

  # EDIT - PRIVATE PORT CREATION - STANDBY
  pkt0_port2:
    type: OS::Neutron::Port
    depends_on: pkt0_vip_port
    properties:
      allowed_address_pairs: 
        - ip_address: { get_param: [pkt0VirtualIpAddress, 0]}
        - ip_address: { get_param: [pkt0VirtualIpAddress, 1]}
        #- ip_address: {get_param: [pkt0_vips,0]}
        #- ip_address: {get_param: [pkt0_vips,1]} 
      network: { get_param : private_network_pkt0 }
      fixed_ips:
        # pkt0 EDIT: uncomment below line to DISABLE DHCP or comment to ENABLE DHCP
        - ip_address: { get_param: [pkt0IPAddressStandby, 0]}
        - ip_address: { get_param: [pkt0IPAddressStandby, 1]}

        # pkt0 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
        #- subnet: { get_param: private_subnet_pkt0}

      # pkt0 EDIT: uncomment below line to ENABLE SR-IOV support or comment to
      # disable it
      #binding:vnic_type: direct
      security_groups:
        - { get_param: security_group }


  # EDIT - PRIVATE PORT CREATION - STANDBY
  pkt1_port2:
    type: OS::Neutron::Port
    depends_on: pkt1_vip_port
    properties:
      allowed_address_pairs: 
        - ip_address: { get_param: [pkt1VirtualIpAddress, 0]}
        - ip_address: { get_param: [pkt1VirtualIpAddress, 1]}
        #- ip_address: {get_param: [pkt1_vips,0]}
        #- ip_address: {get_param: [pkt1_vips,1]} 
      network: { get_param : private_network_pkt1 }
      fixed_ips:
        # pkt1 EDIT: uncomment below line to DISABLE DHCP or comment to ENABLE DHCP
        - ip_address: { get_param: [pkt1IPAddressStandby, 0]}
        - ip_address: { get_param: [pkt1IPAddressStandby, 1]}

        # pkt1 EDIT: uncomment below line to ENABLE DHCP or comment to DISABLE DHCP
        #- subnet: { get_param: private_subnet_pkt1}

      # pkt1 EDIT: uncomment below line to ENABLE SR-IOV support or comment to
      # disable it
      #binding:vnic_type: direct
      security_groups:
        - { get_param: security_group }


# output some stuff for debug
outputs:
  instance1_name:
    description: Name of the instance
    value: { get_attr: [vSBC_ACTIVE, name] }

  instance2_name:
    description: Name of the instance
    value: { get_attr: [vSBC_STANDBY, name] }

  pkt0_Virtual_ip:
    description: Virtual IP address used for the pkt0 interfaces
    value: { get_attr: [pkt0_vip_port, fixed_ips] }

  pkt1_Virtual_ip:
    description: Virtual IP address used for the pkt1 interfaces
    value: { get_attr: [pkt1_vip_port, fixed_ips] }

  mgt0_Virtual_ip:
    description: Virtual IP address used for the logical mgt0 interfaces
    value: { get_attr: [mgt0_vip_port, fixed_ips] }

  # MGT1_EDIT: UNCOMMENT below lines to configure mgt1 interface
  #mgt1_Virtual_ip:
  #  description: Virtual IP address used for the logical mgt1 interfaces
  #  value: { get_attr: [mgt1_vip_port, fixed_ips] }
